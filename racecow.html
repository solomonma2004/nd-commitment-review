<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Derby - ËÜ†ÂéüÈ£õËº™Ë∑ë</title>
    
    <!-- Google Fonts: Fredoka (Cute), Orbitron (Racing) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&family=Orbitron:wght@400;700;900&family=Teko:wght@300;500;700&display=swap" rel="stylesheet">
    
    <!-- PapaParse for CSV Parsing (if needed for CSV fallback) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'cute': ['"Fredoka"', 'sans-serif'],
                        'racing': ['"Orbitron"', 'sans-serif'],
                        'numbers': ['"Teko"', 'sans-serif'],
                    },
                    colors: {
                        'f1-blue': '#0ea5e9',
                        'f1-cyan': '#22d3ee',
                        'f1-slate': '#0f172a',
                    },
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'wiggle': 'wiggle 1s ease-in-out infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        wiggle: {
                            '0%, 100%': { transform: 'rotate(-3deg)' },
                            '50%': { transform: 'rotate(3deg)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        /* Cow Bobbing Animation */
        @keyframes gallop {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(-2deg); }
            75% { transform: translateY(-2px) rotate(2deg); }
        }
        .animate-gallop {
            animation: gallop 0.8s infinite ease-in-out;
        }

        /* --- THEME BACKGROUNDS --- */

        /* 3. Farm Theme (Cute & Green) - ONLY THEME LEFT */
        .bg-farm-pattern {
            background-color: #f7fee7;
            background-image: 
                radial-gradient(#d9f99d 2px, transparent 2px),
                radial-gradient(#d9f99d 2px, transparent 2px);
            background-size: 40px 40px;
            background-position: 0 0, 20px 20px;
        }
        .bg-dirt-track {
            background-color: #a47148; /* Lighter dirt color */
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%2378350f' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M0 38.59l2.83-2.83 1.41 1.41L1.41 40H0v-1.41zM0 1.4l2.83 2.83 1.41-1.41L1.41 0H0v1.41zM38.59 40l-2.83-2.83 1.41-1.41L40 38.59V40h-1.41zM40 1.41l-2.83 2.83-1.41-1.41L38.59 0H40v1.41zM20 18.6l2.83-2.83 1.41 1.41L21.41 20l2.83 2.83-1.41 1.41L20 21.41l-2.83 2.83-1.41-1.41L18.59 20l-2.83-2.83 1.41-1.41L20 18.59z'/%3E%3C/g%3E%3C/svg%3E");
        }
        
        .clip-hud {
            /* No clip path for cute mode, we use rounded corners */
        }
    </style>
</head>
<body class="font-cute selection:bg-yellow-200 selection:text-orange-900 overflow-x-hidden">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        // --- THEME CONFIGURATIONS (Enhanced for Cuteness) ---
        const THEME = {
            id: 'FARM',
            name: 'üêÆ Ëæ≤Â†¥Ê¥æÂ∞ç',
            bgClass: 'bg-farm-pattern',
            textMain: 'text-green-800',
            textSub: 'text-green-600',
            cardBg: 'bg-white border-4 border-green-200 shadow-[0_8px_0_rgba(22,163,74,0.2)]', // Sticker style
            trackBg: 'bg-dirt-track',
            trackBorder: 'border-8 border-orange-300', // Chunky border
            trackHeader: 'bg-green-500 border-b-8 border-green-700 text-white',
            laneBorder: 'border-orange-200/50',
            turboColor: '#fdba74', // Dust
            hudIconColor: 'text-orange-500',
            milestoneBg: 'bg-yellow-400 border-orange-500' // Balloon/Sign color
        };

        // --- ICONS (SVG Components) ---
        const IconBase = ({ children, className, size = 24, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Trophy = (props) => <IconBase {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const Info = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>;
        const Store = (props) => <IconBase {...props}><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7v3a2 2 0 0 1-2 2v0a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12v0a2 2 0 0 1-2-2V7"/></IconBase>;
        const Award = (props) => <IconBase {...props}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;
        const Target = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;
        const Gift = (props) => <IconBase {...props}><polyline points="20 12 20 22 4 22 4 12" /><rect x="2" y="7" width="20" height="5" /><line x1="12" y1="22" x2="12" y2="7" /><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z" /><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z" /></IconBase>;
        const Calendar = (props) => <IconBase {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></IconBase>;
        const Building = (props) => <IconBase {...props}><rect x="4" y="2" width="16" height="20" rx="2" ry="2" /><line x1="9" y1="22" x2="9" y2="22.01" /><line x1="15" y1="22" x2="15" y2="22.01" /><line x1="12" y1="22" x2="12" y2="22.01" /><line x1="12" y1="2" x2="12" y2="4" /><line x1="4" y1="6" x2="20" y2="6" /><line x1="4" y1="10" x2="20" y2="10" /><line x1="4" y1="14" x2="20" y2="14" /><line x1="4" y1="18" x2="20" y2="18" /></IconBase>;

        // --- CONFIGURATION ---
        
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxghoGKevzCyi7UvKx0bzdmSCiOqM_MrP_Z1TLiJhxORi4Oz-6gJHb5oX2e-0b584Ze/exec"; 

        const BRAND_GIFS = {
            "Dermes": "https://i.postimg.cc/DZ0SprZG/DC.gif",
            "Reenex": "https://i.postimg.cc/PxJCVWxw/RC.gif",
            "Elyze": "https://i.postimg.cc/W3zdYG3D/EC.gif"
        };
        const BRAND_COLORS = {
            "Dermes": "#f97316", // Orange
            "Reenex": "#991b1b", // Red
            "Elyze": "#4ade80"   // Green
        };

        // Fallback Sample Data
        const SAMPLE_RACERS = [
            { id: 1, name: "Sarah Miller", brand: "Dermes", shop: "TS", trial_qty: 4, package_sales: 20000, combo_qty: 2, plla_qty: 3, polyca_qty: 3, device_qty: 0, sales: 12.5 },
            { id: 2, name: "Jessica Wilson", brand: "Reenex", shop: "PP", trial_qty: 10, package_sales: 50000, combo_qty: 5, plla_qty: 6, polyca_qty: 0, device_qty: 1, sales: 45.2 },
            { id: 3, name: "Elena Rodriguez", brand: "Elyze", shop: "TST", trial_qty: 2, package_sales: 10000, combo_qty: 1, plla_qty: 0, polyca_qty: 3, device_qty: 0, sales: 9.8 },
            { id: 4, name: "Michelle Chang", brand: "Dermes", shop: "LP", trial_qty: 6, package_sales: 30000, combo_qty: 3, plla_qty: 3, polyca_qty: 0, device_qty: 1, sales: 26.5 },
            { id: 5, name: "Anna Patel", brand: "Reenex", shop: "TS", trial_qty: 12, package_sales: 60000, combo_qty: 6, plla_qty: 9, polyca_qty: 6, device_qty: 2, sales: 62.5 },
            { id: 6, name: "Lisa Wang", brand: "Elyze", shop: "PP", trial_qty: 8, package_sales: 40000, combo_qty: 2, plla_qty: 3, polyca_qty: 0, device_qty: 0, sales: 31.0 },
            { id: 7, name: "Tiffany Baker", brand: "Dermes", shop: "TST", trial_qty: 2, package_sales: 5000, combo_qty: 1, plla_qty: 0, polyca_qty: 0, device_qty: 0, sales: 8.2 },
            { id: 8, name: "Kelly Sato", brand: "Reenex", shop: "LP", trial_qty: 4, package_sales: 25000, combo_qty: 2, plla_qty: 0, polyca_qty: 3, device_qty: 0, sales: 19.5 },
            { id: 9, name: "Amanda Lewis", brand: "Elyze", shop: "TS", trial_qty: 3, package_sales: 15000, combo_qty: 0, plla_qty: 3, polyca_qty: 0, device_qty: 0, sales: 11.0 },
            { id: 10, name: "Jenny T.", brand: "Dermes", shop: "PP", trial_qty: 5, package_sales: 22000, combo_qty: 2, plla_qty: 3, polyca_qty: 0, device_qty: 1, sales: 22.0 }
        ];

        // --- VISUAL COMPONENTS ---

        const F1Card = ({ children, className = "", theme }) => (
            // Added transition-transform and hover:scale for fun interaction
            <div className={`${theme.cardBg} rounded-3xl overflow-hidden relative group hover:scale-[1.02] transition-all duration-300 ${className}`}>
                {children}
            </div>
        );

        // --- COMPONENT: IMPACTFUL STRAIGHT TRACK (TOP 15 - 5 per Brand) ---
        const ImpactfulStraightTrack = ({ data, title, theme, height = "auto" }) => {
            const maxSales = Math.max(...data.map(r => r.sales), 10); 
            // Scale ensuring landmarks visible (at least 85 miles now, or leader * 1.35)
            const trackMax = Math.max(maxSales * 1.35, 85); 
            
            const formatMiles = (val) => `${val.toFixed(1)} Ëã±Èáå`;
            const getBrandGif = (brand) => BRAND_GIFS[brand] || "https://placehold.co/600x338/e2e8f0/64748b?text=Running+Cow";

            const racerCount = data.length || 1;
            // Compact Mode: Reduce lane height to 65px per racer (approx) - MORE COMPACT
            // Minimum track height 300px
            const LANE_HEIGHT = 65;
            // Space between turf and lanes - COMPACT
            const VERTICAL_PADDING = 50;

            const computedHeight = Math.max((racerCount * LANE_HEIGHT) + (VERTICAL_PADDING * 2), 300);
            
            // Percentage of one lane relative to total height (NOT USED for positioning anymore, using pixels for better control)
            
            return (
                /* Main Track Container - rounded-3xl for cute look */
                <div className={`rounded-[2.5rem] overflow-hidden ${theme.trackBorder} shadow-2xl relative transition-colors duration-500 bg-white/5`}>
                    
                    {/* Header */}
                    <div className={`${theme.trackHeader} p-6 flex flex-col md:flex-row justify-between items-center relative z-30 shadow-lg transition-colors duration-500`}>
                        <h2 className="text-2xl md:text-3xl font-cute font-bold flex items-center tracking-wide mb-2 md:mb-0">
                        <span className="mr-3 text-4xl animate-bounce">üèÅ</span> {title}
                        </h2>
                        <div className="text-lg font-cute font-bold bg-white/20 px-6 py-2 rounded-full backdrop-blur-sm border-2 border-white/30 shadow-sm">
                            Ë≥ΩÁ®ãÁØÑÂúç: 0 - {formatMiles(trackMax)}
                        </div>
                    </div>
                    
                    {/* Track Area */}
                    <div className={`relative w-full ${theme.trackBg} transition-colors duration-500`} style={{ height: `${computedHeight}px` }}>
                        
                        {/* 1. Track Surface & Racers (CLIPPED) */}
                        <div className="absolute inset-0 overflow-hidden">
                             {/* Spectator Stands/Turf Top */}
                             <div className={`absolute top-0 left-0 right-0 h-16 ${theme.id === 'FARM' ? 'bg-green-600' : 'bg-black/20'} z-10 border-b-4 ${theme.trackBorder} shadow-inner`}></div>
                             
                             {/* Spectator Stands/Turf Bottom */}
                             <div className={`absolute bottom-0 left-0 right-0 h-16 ${theme.id === 'FARM' ? 'bg-green-600' : 'bg-black/20'} z-10 border-t-4 ${theme.trackBorder} shadow-inner`}></div>
                             
                             {/* Stadium Lights Effect (Only for F1/Space) */}
                             {theme.id !== 'FARM' && (
                                <>
                                    <div className="absolute top-0 left-0 w-64 h-64 bg-white/20 blur-3xl rounded-full pointer-events-none"></div>
                                    <div className="absolute top-0 right-0 w-64 h-64 bg-white/20 blur-3xl rounded-full pointer-events-none"></div>
                                </>
                             )}

                             {/* Lanes */}
                             {Array.from({length: racerCount}).map((_, i) => (
                                <div key={i} className={`absolute w-full border-b-2 border-dashed ${theme.laneBorder}`} 
                                     style={{ top: `${VERTICAL_PADDING + (i * LANE_HEIGHT)}px`, height: `${LANE_HEIGHT}px` }}></div>
                             ))}
                             
                             {/* Fixed Left Ranking Column */}
                             <div className="absolute left-4 top-0 bottom-0 w-12 z-30 pointer-events-none">
                                {Array.from({length: racerCount}).map((_, i) => (
                                    <div 
                                        key={i} 
                                        className="absolute left-0 w-full flex items-center justify-center"
                                        style={{ 
                                            top: `${VERTICAL_PADDING + (i * LANE_HEIGHT)}px`, 
                                            height: `${LANE_HEIGHT}px` 
                                        }}
                                    >
                                        <div className={`w-10 h-10 rounded-full flex items-center justify-center text-xl font-cute font-bold text-white shadow-lg
                                            ${i === 0 ? 'bg-yellow-400 border-4 border-yellow-200 scale-125 z-10' : 
                                              i === 1 ? 'bg-slate-400 border-4 border-slate-300' : 
                                              i === 2 ? 'bg-orange-700 border-4 border-orange-600' : 'bg-slate-700/80'}`}>
                                            {i + 1}
                                        </div>
                                    </div>
                                ))}
                             </div>
                             
                             {/* Start Line Grid - FIXED POSITION AT LEFT 64px */}
                             <div className="absolute left-16 w-16 z-0 flex flex-col justify-center items-center opacity-70"
                                  style={{ top: `${VERTICAL_PADDING}px`, bottom: `${VERTICAL_PADDING}px` }}>
                                <div className="w-full h-full rounded-full" style={{ backgroundImage: 'linear-gradient(45deg, #000 25%, transparent 25%, transparent 75%, #000 75%), linear-gradient(45deg, #000 25%, transparent 25%, transparent 75%, #000 75%)', backgroundSize: '20px 20px', backgroundPosition: '0 0, 10px 10px' }}></div>
                                <div className={`absolute transform -rotate-90 ${theme.id === 'SPACE' ? 'text-cyan-200' : 'text-white'} font-cute font-bold text-4xl tracking-widest whitespace-nowrap drop-shadow-md`}>START</div>
                             </div>

                             {/* 3. The Racers */}
                             {/* Added pl-14 to match Start Line position */}
                            <div className="absolute inset-0 pointer-events-none pl-14"> 
                                {data.map((racer, index) => {
                                    const progress = Math.min((racer.sales / trackMax) * 100, 95); 
                                    // Base offset is now 0 relative to padding
                                    const leftPos = progress * 0.9;
                                    
                                    const isNearEnd = progress > 55;
                                    const labelClass = isNearEnd 
                                        ? "right-full mr-6 flex-row-reverse" 
                                        : "left-full ml-6";

                                    let trailColor = "from-transparent to-white";
                                    if (racer.brand === "Dermes") trailColor = "from-transparent via-orange-500 to-orange-200";
                                    if (racer.brand === "Reenex") trailColor = "from-transparent via-red-600 to-red-400";
                                    if (racer.brand === "Elyze") trailColor = "from-transparent via-emerald-500 to-emerald-200";

                                    return (
                                        <div 
                                            key={racer.id} 
                                            className="absolute w-full group z-20 hover:z-50 pointer-events-auto"
                                            style={{ 
                                                top: `${VERTICAL_PADDING + (index * LANE_HEIGHT)}px`, 
                                                height: `${LANE_HEIGHT}px` 
                                            }}
                                        >
                                            <div className="relative w-full h-full">
                                                <div 
                                                    className="absolute transform -translate-y-1/2 transition-all duration-1000 ease-linear flex items-center group-hover:z-[100]"
                                                    style={{ left: `${leftPos}%`, top: '50%' }}
                                                >
                                                    {/* Fun Turbo Trail / Dust */}
                                                    <div className={`absolute right-10 top-1/2 -translate-y-1/2 -z-10`}>
                                                        {theme.id === 'FARM' ? (
                                                            // Dust Clouds for Farm
                                                            <div className="flex space-x-[-10px] opacity-70">
                                                                <div className="w-8 h-8 bg-orange-200/50 rounded-full animate-ping" style={{animationDuration: '1s'}}></div>
                                                                <div className="w-6 h-6 bg-orange-100/50 rounded-full animate-ping" style={{animationDuration: '1.2s', animationDelay: '0.1s'}}></div>
                                                            </div>
                                                        ) : (
                                                            // Speed lines for others
                                                            <div className={`h-4 w-48 bg-gradient-to-r from-transparent to-${theme.turboColor} rounded-full blur-[2px] opacity-60`}></div>
                                                        )}
                                                    </div>

                                                    {/* Cow with Bobbing Animation */}
                                                    <div className="relative z-30 transform cursor-pointer animate-gallop hover:scale-110 transition-transform">
                                                        {index < 3 && theme.id !== 'FARM' && (
                                                            <div className={`absolute -inset-4 ${theme.id === 'SPACE' ? 'bg-cyan-400/30' : 'bg-white/40'} rounded-full blur-xl animate-pulse -z-10`}></div>
                                                        )}
                                                        
                                                        <img 
                                                            src={getBrandGif(racer.brand)} 
                                                            alt={racer.name} 
                                                            className={`h-12 md:h-16 w-auto object-contain filter drop-shadow-xl ${index===0 ? 'scale-110' : ''}`}
                                                        />
                                                        
                                                        {/* Cute Name Tag Bubble */}
                                                        <div className={`absolute ${labelClass} bg-slate-900/90 text-white px-2 py-0.5 md:px-3 md:py-1 rounded-lg text-[9px] md:text-[10px] font-bold shadow-xl border border-slate-500 z-[60] backdrop-blur-md transition-all whitespace-nowrap min-w-max group-hover:scale-100 group-hover:opacity-100 top-1/2 -translate-y-1/2 flex items-center`}>
                                                            <span className={isNearEnd ? "ml-1 order-2" : "mr-1"}>{racer.name.split(' ')[0]}</span>
                                                            <span className={`text-yellow-400 bg-black/30 px-1 rounded ${isNearEnd ? "order-1" : ""}`}>{formatMiles(racer.sales)}</span>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* 2. Milestones (Cuter Markers) */}
                        {/* Added pl-14 to match Start Line and Racers */}
                        <div className="absolute inset-0 pointer-events-none pl-14">
                            {[20, 40, 60].map((mile, idx) => {
                                const pct = (mile / trackMax) * 100;
                                if (pct > 95) return null; 
                                
                                let archColor = "border-cyan-400";
                                let badgeColor = "bg-cyan-500";
                                if(mile===40) { archColor = "border-blue-500"; badgeColor = "bg-blue-600"; }
                                if(mile===60) { archColor = "border-purple-500"; badgeColor = "bg-purple-600"; }

                                const isTop = idx % 2 === 0;
                                const labelPositionClass = isTop 
                                    ? "-top-16"
                                    : "top-full mt-16";

                                return (
                                    <div key={mile} className="absolute w-1 z-40 pointer-events-none" 
                                         style={{ 
                                             left: `${pct * 0.9}%`, // Matches racer movement
                                             top: `${VERTICAL_PADDING}px`,
                                             bottom: `${VERTICAL_PADDING}px`
                                         }}>
                                        
                                        {/* Dotted Line */}
                                        <div className={`h-full w-0 border-l-4 border-dotted ${theme.milestoneBg.split(' ')[0]} opacity-50`}></div>
                                        
                                        {/* Floating Label - Balloon Style */}
                                        <div className={`absolute ${labelPositionClass} -left-20 w-40 flex flex-col items-center z-50`}>
                                            <div className={`relative ${theme.milestoneBg} text-white font-cute font-bold py-2 px-4 rounded-full shadow-lg text-center transform hover:scale-110 transition-transform`}>
                                                <span className="text-lg">üö© {mile}</span> <span className="text-xs opacity-90">MILES</span>
                                                {/* Little triangle pointer */}
                                                <div className={`absolute left-1/2 -translate-x-1/2 w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent ${isTop ? 'border-t-[8px] border-t-current top-full' : 'border-b-[8px] border-b-current bottom-full'} ${theme.milestoneBg.split(' ')[0].replace('bg-', 'text-')}`}></div>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN COMPONENT ---

        function SalesDerbyBlue() {
            const [racers, setRacers] = useState(SAMPLE_RACERS);
            const [isLoading, setIsLoading] = useState(false);
            const [lastUpdated, setLastUpdated] = useState(null);
            const [fetchError, setFetchError] = useState(false);
            const [currentTheme, setCurrentTheme] = useState('FARM'); // Default to Farm
            
            // Scorecard State
            const [scBrand, setScBrand] = useState("ALL");
            const [scShop, setScShop] = useState("ALL");
            const [scRacerId, setScRacerId] = useState("");

            // Floor Stats State
            const [floorBrandFilter, setFloorBrandFilter] = useState("ALL");

            const theme = THEME; // Use the single theme

            // --- DATA FETCHING ---
            const fetchData = () => {
                if (!GOOGLE_SCRIPT_URL) return;
                
                setIsLoading(true);
                setFetchError(false);
                
                fetch(GOOGLE_SCRIPT_URL, {
                    method: 'GET',
                    redirect: 'follow',
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log("Fetched Data:", data);
                    if (data && data.length > 0) {
                        const normalizeKeys = (obj) => {
                            const newObj = {};
                            Object.keys(obj).forEach(key => {
                                const newKey = key.toLowerCase().replace(/[\s_]/g, '');
                                newObj[newKey] = obj[key];
                            });
                            return newObj;
                        };

                        const parseNum = (val) => {
                            if (typeof val === 'number') return val;
                            if (typeof val === 'string') return parseFloat(val.replace(/[$,]/g, '')) || 0;
                            return 0;
                        };

                        const newRacers = data
                            .map((row) => normalizeKeys(row))
                            .filter(row => row.name)
                            .map((row, index) => {
                                const trialQty = parseNum(row.trialqty);
                                const packageSales = parseNum(row.packagesales);
                                const comboQty = parseNum(row.comboqty);
                                const pllaQty = parseNum(row.pllaqty);
                                const polycaQty = parseNum(row.polycaqty);
                                const deviceQty = parseNum(row.deviceqty);

                                const milesTrial = trialQty * 2; 
                                const milesPackage = Math.floor(packageSales / 10000) * 2; 
                                const milesCombo = comboQty * 4; 
                                const milesPlla = Math.floor(pllaQty / 2) * 2; 
                                const milesDevice = deviceQty * 3; 

                                const totalMiles = milesTrial + milesPackage + milesCombo + milesPlla + milesDevice;

                                return {
                                    id: index + 1,
                                    name: row.name,
                                    brand: row.brand || "Unknown",
                                    shop: row.shop || "HQ", 
                                    trial_qty: trialQty,
                                    package_sales: packageSales,
                                    combo_qty: comboQty,
                                    plla_qty: pllaQty,
                                    device_qty: deviceQty,
                                    sales: totalMiles,
                                    color: BRAND_COLORS[row.brand] || "#94a3b8"
                                };
                            });
                        
                        setRacers(newRacers);
                        setLastUpdated(new Date());
                        setFetchError(false);
                    }
                    setIsLoading(false);
                })
                .catch(err => {
                    console.warn("Error fetching data (using sample data):", err);
                    setFetchError(true);
                    setIsLoading(false);
                });
            };

            useEffect(() => {
                fetchData();
                const interval = setInterval(fetchData, 30000);
                return () => clearInterval(interval);
            }, []);

            const sortedGlobal = [...racers].sort((a, b) => b.sales - a.sales);
            const top3 = sortedGlobal.slice(0, 3);
            
            const getTop5ByBrand = (brandName) => {
                return racers
                    .filter(r => r.brand === brandName)
                    .sort((a, b) => b.sales - a.sales)
                    .slice(0, 5);
            };

            const top5Dermes = getTop5ByBrand("Dermes");
            const top5Reenex = getTop5ByBrand("Reenex");
            const top5Elyze = getTop5ByBrand("Elyze");
            const top15Combined = [...top5Dermes, ...top5Reenex, ...top5Elyze]
                .sort((a, b) => b.sales - a.sales);
            
            const brands = [...new Set(racers.map(r => r.brand))];
            const shops = [...new Set(racers.map(r => r.shop))].sort();

            const scAvailableRacers = useMemo(() => {
                return racers.filter(r => {
                    const matchBrand = scBrand === "ALL" || r.brand === scBrand;
                    const matchShop = scShop === "ALL" || r.shop === scShop;
                    return matchBrand && matchShop;
                }).sort((a, b) => a.name.localeCompare(b.name));
            }, [racers, scBrand, scShop]);

            useEffect(() => {
                if (scAvailableRacers.length > 0) {
                    const exists = scAvailableRacers.find(r => r.id.toString() === scRacerId);
                    if (!exists) {
                        setScRacerId(scAvailableRacers[0].id.toString());
                    }
                } else {
                    setScRacerId("");
                }
            }, [scAvailableRacers, scRacerId]);

            const formatMiles = (val) => `${val.toFixed(1)} Ëã±Èáå`;
            const formatCurrency = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'HKD', maximumFractionDigits: 0 }).format(val);

            const getBrandGif = (brand) => {
                return BRAND_GIFS[brand] || "https://placehold.co/600x338/e2e8f0/64748b?text=Running+Cow";
            };

            const getRacerBreakdown = (racer) => {
                if (!racer) return null;
                return {
                    pnPaidTrial: racer.trial_qty || 0,
                    pnPackage: racer.package_sales || 0, 
                    combo: racer.combo_qty || 0,
                    plla: racer.plla_qty || 0,
                    device: racer.device_qty || 0,
                };
            };

            // Calculate floor stats
            const floorStats = useMemo(() => {
                const map = {};
                racers.forEach(r => {
                    if (floorBrandFilter !== "ALL" && r.brand !== floorBrandFilter) return;
                    if (!map[r.shop]) {
                        map[r.shop] = { shop: r.shop, miles: 0, count: 0, brands: new Set() };
                    }
                    map[r.shop].miles += r.sales;
                    map[r.shop].count += 1;
                    map[r.shop].brands.add(r.brand);
                });
                return Object.values(map).sort((a, b) => b.miles - a.miles);
            }, [racers, floorBrandFilter]);

            // REWARD DATA
            const REWARDS = [
                { miles: 20, title: "20Ëã±Èáå", reward: "CelluionÊ¥ªÊÄßËÜ†ÂéüÂñöËÜöÁµÑÂêà (Mask x 2 + Spray)", icon: "üéÅ", color: "blue" },
                { miles: 30, title: "30Ëã±Èáå", reward: "CelluionÊ¥ªÊÄßËÜ†ÂéüÂñöËÜöÁµÑÂêà (Mask x 4 + Spray) + NeoStrata Êõ¥ÁîüÊ¥ªËÜöÂï´Âñ±Èù¢ËÜú 125ml", icon: "‚ú®", color: "purple" },
                { miles: 40, title: "40Ëã±Èáå", reward: "CelluJet PN+Èõ¢Â≠êËÜ†ÂéüÂÜçÁîüÈù¢ÈÉ®ÁôÇÁ®ã & PLLA 5 Â•óË£ù (ÂêçÈ°çÂçÅ‰Ωç)", icon: "üíÜ‚Äç‚ôÄÔ∏è", color: "pink" },
                { miles: 50, title: "50Ëã±Èáå", reward: "‰∏âÊúàÈ°çÂ§ñ‰∏ÄÂ§©ÂÅáÊúü (ÊúÄÂø´ÂçÅ‰Ωç)", icon: "üèñÔ∏è", color: "green" },
                { miles: 50, title: "50Ëã±Èáå (Top 3)", reward: "Ë∑ëÂæóÊúÄÈÅ†È†≠‰∏âÂêçÈ°çÂ§ñ$1,000ÁèæÈáëÁçé!", icon: "üèÜ", color: "yellow" }
            ];

            // Brand Breakdown Calculations
            const dermesTotal = racers.filter(r => r.brand === 'Dermes').reduce((a, b) => a + b.sales, 0);
            const reenexTotal = racers.filter(r => r.brand === 'Reenex').reduce((a, b) => a + b.sales, 0);
            const elyzeTotal = racers.filter(r => r.brand === 'Elyze').reduce((a, b) => a + b.sales, 0);
            const grandTotal = dermesTotal + reenexTotal + elyzeTotal || 1; // avoid division by zero

            const dermesPct = (dermesTotal / grandTotal) * 100;
            const reenexPct = (reenexTotal / grandTotal) * 100;
            const elyzePct = (elyzeTotal / grandTotal) * 100;

            return (
                <div className={`min-h-screen ${theme.bgClass} font-cute selection:bg-yellow-200 selection:text-orange-900 relative transition-colors duration-1000`}>
                
                {/* --- SECTION 1: GAME POSTER --- */}
                <section className="relative w-full bg-white shadow-xl z-20 border-b-8 border-green-500">
                    <div className="w-full">
                        <img 
                        src="https://i.postimg.cc/90qwfFYV/jimeng-2026-01-17-3723-ji-zhi-pang-pang-de-niu-zai-zhuan-ye-sai-dao-shang-gun-dong-zhe-fa-guang-de-qiu-ti-jin-xing-bi-sai-qiu-ti-dai-biao-jiao-yuan-dan-bai-zeng-qiang-qiu-yi-ban-xian.png" 
                        alt="Main Event Poster" 
                        className="w-full h-auto object-cover block"
                        />
                    </div>
                </section>

                <main className="max-w-7xl mx-auto p-4 md:p-8 space-y-16 pb-24">

                    {/* --- SECTION 2: STATS HUD (FUN & CUTE) --- */}
                    <section className="w-full">
                        <div className="text-center mb-8">
                            <h1 className={`text-4xl md:text-7xl font-cute font-bold text-transparent bg-clip-text bg-gradient-to-br from-green-600 to-yellow-500 drop-shadow-sm mb-4 animate-wiggle`}>
                            ËÜ†ÂéüÈ£õËº™Ë∑ë üêÆ
                            </h1>
                            <div className="inline-block bg-white text-green-600 px-8 py-2 rounded-full border-4 border-green-400 shadow-lg transform rotate-[-2deg] hover:rotate-[2deg] transition-transform">
                                <span className="block text-xl md:text-2xl font-bold tracking-widest">ÂÖ®Ê∞ëÁ´∂Ë∑ë„ÄÇ‰∫∫‰∫∫ÊØèÊó•‰∫åÂçÅËã±Èáå</span>
                            </div>
                        </div>

                        {/* TELEMETRY CARDS */}
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                             {/* Brand Strength Dashboard (Updated Title Size) */}
                             <F1Card theme={theme} className="p-5 flex flex-col justify-between h-full bg-white relative overflow-hidden">
                                {/* Background Decoration */}
                                <div className={`absolute -right-6 -top-6 w-32 h-32 rounded-full blur-3xl opacity-40 bg-green-300`}></div>
                                
                                <div className="flex justify-between items-start relative z-10 mb-2">
                                    <div>
                                        {/* Increased text size from text-sm to text-2xl */}
                                        <h3 className={`${theme.textSub} text-2xl font-bold tracking-wider uppercase mb-1`}>Á∏ΩÁç≤ÂæóËã±Èáå</h3>
                                        <div className={`text-6xl font-cute font-black ${theme.textMain} leading-none tracking-tight`}>
                                            {racers.reduce((a,b)=>a+b.sales,0).toFixed(1)}
                                            <span className="text-xl ml-1 font-bold opacity-50">MILES</span>
                                        </div>
                                    </div>
                                    <div className={`p-3 rounded-2xl shadow-sm bg-green-100 text-green-600`}>
                                        <Award className="animate-bounce-slow" size={28} />
                                    </div>
                                </div>

                                {/* Stacked Distribution Bar */}
                                <div className="w-full h-6 rounded-full overflow-hidden mb-4 border border-slate-200 flex shadow-inner relative">
                                    <div className="h-full bg-orange-500 flex items-center justify-center text-[10px] text-white font-bold transition-all duration-500" style={{ width: `${dermesPct}%` }}>
                                        {dermesPct > 10 && `${dermesPct.toFixed(0)}%`}
                                    </div>
                                    <div className="h-full bg-red-600 flex items-center justify-center text-[10px] text-white font-bold transition-all duration-500" style={{ width: `${reenexPct}%` }}>
                                        {reenexPct > 10 && `${reenexPct.toFixed(0)}%`}
                                    </div>
                                    <div className="h-full bg-green-500 flex items-center justify-center text-[10px] text-white font-bold transition-all duration-500" style={{ width: `${elyzePct}%` }}>
                                        {elyzePct > 10 && `${elyzePct.toFixed(0)}%`}
                                    </div>
                                </div>
                                
                                {/* Compact Brand Breakdown */}
                                <div className="grid grid-cols-3 gap-2 relative z-10">
                                    {[
                                        { name: 'Dermes', color: 'orange', bg: 'bg-orange-50', text: 'text-orange-600', border: 'border-orange-100', val: dermesTotal },
                                        { name: 'Reenex', color: 'red', bg: 'bg-red-50', text: 'text-red-600', border: 'border-red-100', val: reenexTotal },
                                        { name: 'Elyze', color: 'green', bg: 'bg-green-50', text: 'text-green-600', border: 'border-green-100', val: elyzeTotal }
                                    ].map(brand => (
                                        <div key={brand.name} className={`${brand.bg} rounded-xl p-2 text-center border ${brand.border} shadow-sm hover:scale-105 transition-transform`}>
                                            <div className={`text-[10px] ${brand.text} font-bold uppercase tracking-wide opacity-80`}>{brand.name}</div>
                                            <div className={`font-cute font-bold ${brand.text} text-xl leading-none mt-0.5`}>{brand.val.toFixed(1)}</div>
                                        </div>
                                    ))}
                                </div>
                             </F1Card>

                             {/* Racers HUD (Updated Title Size) */}
                             <F1Card theme={theme} className="p-6 flex flex-col justify-between h-full bg-white">
                                <div className="flex justify-between items-start">
                                    {/* Increased text size from text-xl to text-2xl */}
                                    <h3 className={`${theme.textSub} text-2xl font-bold tracking-wider`}>ÈÅ∏ÊâãÊï∏Èáè</h3>
                                    <div className="bg-blue-100 p-3 rounded-full text-blue-500">
                                        <Store className="animate-pulse" size={32} />
                                    </div>
                                </div>
                                <div className="flex items-end justify-between">
                                     <div className={`text-6xl font-cute font-bold ${theme.textMain}`}>{racers.length}</div>
                                     <div className={`text-sm ${theme.textSub} mb-3 font-bold bg-slate-100 px-3 py-1 rounded-full`}>ON TRACK</div>
                                </div>
                             </F1Card>

                             {/* Top Leader HUD */}
                             <F1Card theme={theme} className={`p-6 flex flex-col justify-between h-full bg-gradient-to-br from-yellow-50 to-orange-50 border-none`}>
                                <div className="flex justify-between items-start">
                                    <h3 className={`text-orange-800 text-xl font-bold tracking-wider`}>ÁõÆÂâçÁ¨¨‰∏ÄÂêç</h3>
                                    <div className="bg-yellow-300 p-3 rounded-full text-yellow-800 shadow-md">
                                        <Trophy className="animate-bounce" size={32} />
                                    </div>
                                </div>
                                <div>
                                    <div className={`text-3xl font-bold text-orange-900 truncate mb-1`}>{top3[0]?.name}</div>
                                    <div className={`text-orange-600 font-cute text-2xl font-bold`}>{top3[0]?.sales.toFixed(1)} MILES</div>
                                </div>
                             </F1Card>
                        </div>
                    </section>

                    {/* --- NEW SECTION: FLOOR PERFORMANCE LEADERBOARD --- */}
                    <section className="w-full">
                        <div className="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-4">
                            <h3 className={`text-2xl md:text-3xl font-cute ${theme.textMain} font-bold flex items-center gap-3`}>
                                <span className="bg-purple-100 p-1.5 rounded-full"><Building className="text-purple-600" size={24} /></span> Ê®ìÂ±§Ë°®ÁèæÈæçËôéÊ¶ú
                            </h3>
                            <div className="flex gap-2">
                                {['ALL', 'Dermes', 'Reenex', 'Elyze'].map(b => (
                                    <button
                                        key={b}
                                        onClick={() => setFloorBrandFilter(b)}
                                        className={`px-4 py-1.5 rounded-full text-sm font-bold border-2 transition-all ${
                                            floorBrandFilter === b 
                                            ? 'bg-purple-500 text-white border-purple-600 shadow-md' 
                                            : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'
                                        }`}
                                    >
                                        {b === 'ALL' ? 'ÂÖ®ÈÉ®' : b}
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                            {floorStats.map((shop, idx) => (
                                <F1Card key={shop.shop} theme={theme} className="p-4 bg-white hover:-translate-y-1 hover:shadow-lg transition-all relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-2 opacity-10">
                                        <Trophy size={64} className="text-slate-800" />
                                    </div>
                                    <div className="relative z-10">
                                        <div className="flex justify-between items-center mb-2">
                                            <div className="flex items-center gap-2">
                                                <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm text-white shadow-sm ${
                                                    idx === 0 ? 'bg-yellow-400' : 
                                                    idx === 1 ? 'bg-slate-400' : 
                                                    idx === 2 ? 'bg-orange-400' : 'bg-slate-200 text-slate-500'
                                                }`}>
                                                    {idx + 1}
                                                </div>
                                                <h4 className="font-bold text-lg text-slate-800">{shop.shop}</h4>
                                            </div>
                                            <div className="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-0.5 rounded-full">{shop.count} ‰∫∫</div>
                                        </div>
                                        <div className="text-3xl font-cute font-black text-purple-600 mb-1">
                                            {shop.miles.toFixed(1)} <span className="text-sm text-slate-400 font-bold">MILES</span>
                                        </div>
                                        {/* Mini bar chart */}
                                        <div className="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden">
                                            <div className="h-full bg-purple-400 rounded-full" style={{ width: `${Math.min((shop.miles / (floorStats[0]?.miles || 1)) * 100, 100)}%` }}></div>
                                        </div>
                                    </div>
                                </F1Card>
                            ))}
                            {floorStats.length === 0 && (
                                <div className="col-span-full text-center py-8 text-slate-400 font-cute text-xl">
                                    Ê≤íÊúâÊï∏Êìö üêÆ
                                </div>
                            )}
                        </div>
                    </section>

                    {/* --- SECTION 3: THE RACING COURSE --- */}
                    <section>
                        <ImpactfulStraightTrack data={top15Combined} title="ÂêÑÂìÅÁâå Top 5 ÊøÄÊà∞" theme={theme} height="1500px" />
                    </section>

                    {/* --- SECTION 4: GAME RULES (FUN CARDS) --- */}
                    <section className="grid grid-cols-1 gap-6">
                        <div className="relative">
                             <div className="text-center mb-6">
                                <h3 className={`text-2xl md:text-3xl font-cute ${theme.textMain} font-bold flex items-center justify-center gap-3`}>
                                    <span className="bg-green-100 p-1.5 rounded-full"><Info className="text-green-600" size={20} /></span> Âä†ÈÄüÊîªÁï•
                                </h3>
                                <p className={`${theme.textSub} font-cute text-base mt-1`}>ÊéåÊè°‰ª•‰∏ã‰∫îÂ§ßÊ≥ïÂâáÔºåÂä©ÂäõËÇ•ÁâõÈ£õÈÄüË°ùÂà∫ÔºÅüöÄ</p>
                             </div>

                             <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-3">
                                {/* Rule 1 */}
                                <F1Card theme={theme} className="p-3 bg-white hover:rotate-1 hover:shadow-lg transition-transform h-full flex flex-col justify-between">
                                    <div className="flex items-center gap-2 mb-2">
                                        <div className="w-8 h-8 bg-teal-100 text-teal-600 rounded-full flex items-center justify-center font-bold text-sm shadow-sm shrink-0">1</div>
                                        <h4 className={`text-sm font-bold ${theme.textMain} leading-tight`}>PN+ Paid Trial</h4>
                                    </div>
                                    <div className="bg-slate-50 p-2 rounded-lg mb-2 text-center border border-slate-100 grow flex items-center justify-center">
                                        <p className={`text-xs ${theme.textSub}`}>ÊØèË≥£Âá∫ <strong className="text-teal-600">1 ÂÄã</strong></p>
                                    </div>
                                    <div className="bg-teal-500 text-white text-center py-1 rounded-full font-bold text-xs shadow-md shadow-teal-200">
                                        + 2 Ëã±Èáå üÜï
                                    </div>
                                </F1Card>

                                {/* Rule 2 */}
                                <F1Card theme={theme} className="p-3 bg-white hover:-rotate-1 hover:shadow-lg transition-transform h-full flex flex-col justify-between">
                                    <div className="flex items-center gap-2 mb-2">
                                        <div className="w-8 h-8 bg-cyan-100 text-cyan-600 rounded-full flex items-center justify-center font-bold text-sm shadow-sm shrink-0">2</div>
                                        <h4 className={`text-sm font-bold ${theme.textMain} leading-tight`}>Âê´ PN+ Package</h4>
                                    </div>
                                    <div className="bg-slate-50 p-2 rounded-lg mb-2 text-center border border-slate-100 grow flex items-center justify-center">
                                        <p className={`text-xs ${theme.textSub}`}>ÊØè <strong className="text-cyan-600">$10,000</strong></p>
                                    </div>
                                    <div className="bg-cyan-500 text-white text-center py-1 rounded-full font-bold text-xs shadow-md shadow-cyan-200">
                                        + 2 Ëã±Èáå ‚ö°
                                    </div>
                                </F1Card>

                                {/* Rule 3 */}
                                <F1Card theme={theme} className="p-3 bg-white hover:rotate-1 hover:shadow-lg transition-transform h-full flex flex-col justify-between">
                                    <div className="flex items-center gap-2 mb-2">
                                        <div className="w-8 h-8 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center font-bold text-sm shadow-sm shrink-0">3</div>
                                        <h4 className={`text-sm font-bold ${theme.textMain} leading-tight`}>PN+ Combo</h4>
                                    </div>
                                    <div className="bg-slate-50 p-2 rounded-lg mb-2 text-center border border-slate-100 grow flex items-center justify-center">
                                        <p className={`text-xs ${theme.textSub}`}>PN+ & PLLA5 <strong className="text-blue-600">System</strong></p>
                                    </div>
                                    <div className="bg-blue-500 text-white text-center py-1 rounded-full font-bold text-xs shadow-md shadow-blue-200">
                                        + 4 Ëã±Èáå üöÄ
                                    </div>
                                </F1Card>

                                {/* Rule 4 */}
                                <F1Card theme={theme} className="p-3 bg-white hover:-rotate-1 hover:shadow-lg transition-transform h-full flex flex-col justify-between">
                                    <div className="flex items-center gap-2 mb-2">
                                        <div className="w-8 h-8 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center font-bold text-sm shadow-sm shrink-0">4</div>
                                        <h4 className={`text-sm font-bold ${theme.textMain} leading-tight`}>Plla 5 Product</h4>
                                    </div>
                                    <div className="bg-slate-50 p-2 rounded-lg mb-2 text-center border border-slate-100 grow flex items-center justify-center">
                                        <p className={`text-xs ${theme.textSub}`}>ÊØèË≥£Âá∫ <strong className="text-purple-600">2 ÂÄã</strong> <span className="block scale-90 opacity-75">(ÊäòÂæå$592)</span></p>
                                    </div>
                                    <div className="bg-purple-500 text-white text-center py-1 rounded-full font-bold text-xs shadow-md shadow-purple-200">
                                        + 2 Ëã±Èáå ‚ú®
                                    </div>
                                </F1Card>
                                
                                {/* Rule 5 */}
                                <F1Card theme={theme} className="p-3 bg-white hover:rotate-1 hover:shadow-lg transition-transform h-full flex flex-col justify-between">
                                    <div className="flex items-center gap-2 mb-2">
                                        <div className="w-8 h-8 bg-orange-100 text-orange-600 rounded-full flex items-center justify-center font-bold text-sm shadow-sm shrink-0">5</div>
                                        <h4 className={`text-sm font-bold ${theme.textMain} leading-tight`}>Plla 5 X Ultrajet</h4>
                                    </div>
                                    <div className="bg-slate-50 p-2 rounded-lg mb-2 text-center border border-slate-100 grow flex items-center justify-center">
                                        <p className={`text-xs ${theme.textSub}`}>ÊØèË≥£Âá∫ <strong className="text-orange-600">1 Â•ó</strong></p>
                                    </div>
                                    <div className="bg-orange-500 text-white text-center py-1 rounded-full font-bold text-xs shadow-md shadow-orange-200">
                                        + 3 Ëã±Èáå üî•
                                    </div>
                                </F1Card>
                             </div>
                        </div>
                    </section>

                    {/* --- REWARDS SECTION (NEW) --- */}
                    <section className="grid grid-cols-1 gap-6">
                        <div className="relative">
                             <div className="text-center mb-6">
                                <h3 className={`text-2xl md:text-3xl font-cute ${theme.textMain} font-bold flex items-center justify-center gap-3`}>
                                    <span className="bg-yellow-100 p-1.5 rounded-full"><Gift className="text-yellow-600" size={24} /></span> ÈáåÊï∏ÁçéË≥û
                                </h3>
                                <p className={`${theme.textSub} font-cute text-base mt-1`}>Á¥ØÁ©çÈáåÊï∏ÔºåÊèõÂèñË±êÂØåÁçéÂìÅÔºÅ</p>
                             </div>

                             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                                {REWARDS.map((reward, idx) => (
                                    <F1Card key={idx} theme={theme} className={`p-4 bg-white hover:-translate-y-1 hover:shadow-xl transition-all h-full flex flex-col ${reward.miles === 50 && reward.color === 'yellow' ? 'border-yellow-400 border-4 bg-yellow-50' : ''}`}>
                                        <div className="flex justify-between items-start mb-3">
                                            <span className={`text-3xl`}>{reward.icon}</span>
                                            <span className={`px-3 py-1 rounded-full text-xs font-bold bg-${reward.color}-100 text-${reward.color}-600`}>
                                                {reward.title}
                                            </span>
                                        </div>
                                        <p className={`text-sm font-bold ${theme.textMain} leading-snug`}>
                                            {reward.reward}
                                        </p>
                                    </F1Card>
                                ))}
                             </div>
                        </div>
                    </section>

                    {/* --- SECTION 5: DRIVER LICENSE (SCORECARD) --- */}
                    <section className="pt-12 border-t-4 border-dashed border-slate-300">
                         {/* Header & Filters */}
                        <div className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                            <div>
                                <h2 className={`text-3xl md:text-4xl font-cute ${theme.textMain} flex items-center font-bold`}>
                                    <span className="bg-blue-100 p-2 rounded-full mr-3"><Target className="text-blue-500" /></span> ÂÄã‰∫∫ÊàêÁ∏æÂñÆ
                                </h2>
                                <p className={`${theme.textSub} mt-2 font-cute text-lg ml-2`}>Êü•ÁúãÂÄãÂà•ÂèÉË≥ΩËÄÖÁöÑË©≥Á¥∞ÂæóÂàÜËàá‰ªªÂãôÈÅîÊàêÁãÄÊ≥Å</p>
                            </div>
                            
                            <div className={`flex flex-col sm:flex-row gap-3 items-stretch sm:items-center ${theme.cardBg} p-3 rounded-2xl shadow-lg w-full md:w-auto bg-white`}>
                                <div className="relative flex-1">
                                    <select value={scBrand} onChange={(e) => setScBrand(e.target.value)} className="w-full bg-slate-50 text-slate-700 text-sm rounded-xl pl-4 pr-10 py-3 focus:ring-4 focus:ring-green-200 outline-none border-2 border-slate-100 font-bold uppercase cursor-pointer hover:bg-slate-100 transition-colors appearance-none">
                                        <option value="ALL">ÊâÄÊúâÂìÅÁâå</option>
                                        {brands.map(b => <option key={b} value={b}>{b}</option>)}
                                    </select>
                                    <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">‚ñº</div>
                                </div>
                                <div className="relative flex-1">
                                    <select value={scShop} onChange={(e) => setScShop(e.target.value)} className="w-full bg-slate-50 text-slate-700 text-sm rounded-xl pl-4 pr-10 py-3 focus:ring-4 focus:ring-green-200 outline-none border-2 border-slate-100 font-bold uppercase cursor-pointer hover:bg-slate-100 transition-colors appearance-none">
                                        <option value="ALL">ÊâÄÊúâÊ®ìÂ±§</option>
                                        {shops.map(s => <option key={s} value={s}>{s}</option>)}
                                    </select>
                                    <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">‚ñº</div>
                                </div>
                                <div className="relative flex-1">
                                    <select value={scRacerId} onChange={(e) => setScRacerId(e.target.value)} className="w-full bg-green-500 text-white text-sm rounded-xl pl-4 pr-10 py-3 focus:ring-4 focus:ring-green-300 outline-none border-none font-bold uppercase min-w-[150px] cursor-pointer hover:bg-green-600 transition-colors appearance-none shadow-md">
                                        {scAvailableRacers.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}
                                    </select>
                                    <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-white/80">‚ñº</div>
                                </div>
                            </div>
                        </div>

                        {/* License Card */}
                        {scRacerId && (() => {
                            const racer = racers.find(r => r.id.toString() === scRacerId);
                            // Note: using scRacerId for lookup
                            const actualRank = sortedGlobal.findIndex(r => r.id.toString() === scRacerId) + 1;
                            const breakdown = getRacerBreakdown(racer);

                            if (!racer) return null; // Guard

                            return (
                                <div className="bg-white rounded-[2rem] shadow-2xl overflow-hidden relative border-8 border-slate-100 text-slate-800 transform hover:scale-[1.01] transition-transform duration-500">
                                    <div className="absolute top-0 right-0 p-40 bg-green-100 rounded-full blur-3xl -mr-10 -mt-10 opacity-50"></div>
                                    
                                    <div className="grid grid-cols-1 lg:grid-cols-3 relative z-10">
                                        {/* Left: Profile */}
                                        <div className="p-10 bg-slate-50/80 flex flex-col items-center justify-center border-b lg:border-b-0 lg:border-r-4 border-slate-100 relative">
                                            <div className="w-40 h-40 rounded-full bg-white p-2 mb-6 relative shadow-xl">
                                                <img src={getBrandGif(racer.brand)} className="w-full h-full object-contain rounded-full bg-slate-50" />
                                                <div className="absolute -bottom-2 -right-2 bg-yellow-400 text-yellow-900 w-12 h-12 flex items-center justify-center font-black rounded-full border-4 border-white text-2xl font-cute shadow-lg">#{actualRank}</div>
                                            </div>
                                            <h2 className="text-4xl font-cute font-bold text-center mb-3 text-slate-800">{racer.name}</h2>
                                            <div className="flex gap-2 mb-8">
                                                <span className="px-3 py-1 bg-white border-2 border-slate-200 rounded-full text-xs text-slate-600 font-bold uppercase tracking-wider shadow-sm">{racer.brand}</span>
                                                <span className="px-3 py-1 bg-white border-2 border-slate-200 rounded-full text-xs text-slate-600 font-bold uppercase tracking-wider shadow-sm">{racer.shop}</span>
                                            </div>
                                            
                                            {/* Big Speedometer Number */}
                                            <div className="text-center bg-white p-6 rounded-3xl shadow-sm border-2 border-slate-100 w-full">
                                                <div className="text-xs text-slate-400 uppercase tracking-[0.2em] mb-2 font-bold">Á∏ΩÈáåÁ®ã (Total)</div>
                                                <div className="text-7xl font-cute font-black text-green-500 leading-none">
                                                    {racer.sales.toFixed(1)}
                                                </div>
                                                <div className="text-slate-400 text-sm font-bold mt-1 tracking-widest">MILES</div>
                                            </div>
                                        </div>

                                        {/* Right: Data */}
                                        <div className="lg:col-span-2 p-10 bg-white">
                                            <h4 className="text-slate-400 font-cute uppercase text-sm mb-8 flex items-center font-bold tracking-widest border-b-2 border-slate-100 pb-4">
                                                <Zap size={20} className="mr-2 text-yellow-500" /> Ë°®ÁèæË©≥Á¥∞ÂàÜÊûê
                                            </h4>
                                            
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                                {[
                                                    { 
                                                        label: "PN+ Paid Trial", 
                                                        count: breakdown.pnPaidTrial, 
                                                        points: breakdown.pnPaidTrial * 2, // 1 unit = 2 miles
                                                        color: "teal",
                                                        icon: "üÜï"
                                                    },
                                                    { 
                                                        label: "PN+ Package", 
                                                        count: breakdown.pnPackage, 
                                                        points: Math.floor(breakdown.pnPackage / 10000) * 2, // 10k = 2 miles
                                                        color: "cyan",
                                                        revenue: breakdown.pnPackage,
                                                        icon: "‚ö°"
                                                    },
                                                    { label: "PN+ Combo Sys", count: breakdown.combo, points: breakdown.combo * 4, color: "blue", icon: "üöÄ" }, // 1 unit = 4 miles
                                                    { label: "Plla 5 Product", count: breakdown.plla, points: Math.floor(breakdown.plla / 2) * 2, color: "purple", icon: "‚ú®" }, // 2 units = 2 miles
                                                    { label: "Plla 5 X Ultrajet", count: breakdown.device, points: breakdown.device * 3, color: "orange", icon: "üî•" }, // 1 unit = 3 miles
                                                ].map((item, idx) => (
                                                    <div key={idx} className={`bg-${item.color}-50 rounded-2xl p-5 border-2 border-${item.color}-100 hover:shadow-md transition-shadow`}>
                                                        <div className="flex justify-between items-center mb-3">
                                                            <span className={`text-${item.color}-700 text-xs font-bold uppercase flex items-center`}>
                                                                <span className="mr-2 text-lg">{item.icon}</span> {item.label}
                                                            </span>
                                                            <span className={`bg-white text-${item.color}-600 font-cute text-lg font-bold px-3 py-1 rounded-full shadow-sm`}>+{item.points} M</span>
                                                        </div>
                                                        <div className="w-full bg-white h-3 rounded-full overflow-hidden border border-${item.color}-200">
                                                            <div className={`h-full bg-${item.color}-400 rounded-full`} style={{ width: `${Math.min((item.revenue ? item.points : item.count) * 10, 100)}%` }}></div>
                                                        </div>
                                                        <div className="text-right text-xs text-${item.color}-600 mt-2 font-bold">
                                                            {item.label === "PN+ Package" 
                                                                ? `ÈáëÈ°ç: ${formatCurrency(item.revenue)}` 
                                                                : `Êï∏Èáè: ${item.count}`
                                                            }
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })()}
                    </section>
                </main>

                {/* --- DATA SOURCE STATUS BAR (BOTTOM LEFT) --- */}
                <div className="fixed bottom-4 left-4 z-50 text-[10px] text-slate-500 bg-white/90 px-3 py-2 rounded-full shadow-lg border border-slate-200 backdrop-blur-sm pointer-events-none flex items-center gap-2">
                     {lastUpdated && !fetchError ? (
                        <span className="flex items-center text-green-600 font-bold"><span className="w-2 h-2 rounded-full bg-green-500 mr-2 animate-pulse"></span>Â∑≤ÈÄ£Êé• (Update: {lastUpdated.toLocaleTimeString()})</span>
                     ) : (
                        <span className="flex items-center text-orange-500 font-bold"><span className="w-2 h-2 rounded-full bg-orange-500 mr-2"></span>{fetchError ? 'ÈÄ£Êé•Â§±Êïó: ÊºîÁ§∫Ê®°Âºè' : 'ÊºîÁ§∫Ê®°Âºè'}</span>
                     )}
                </div>

                {/* --- ADMIN FLOATING BUTTON (MANUAL REFRESH) --- */}
                <div className="fixed bottom-6 right-6 flex flex-col gap-2 z-50">
                    <button 
                        onClick={fetchData}
                        className={`p-4 bg-green-500 text-white rounded-full shadow-2xl hover:bg-green-600 hover:scale-110 transition-all group ${isLoading ? 'animate-spin' : ''}`}
                        title="Á´ãÂç≥Âà∑Êñ∞Êï∏Êìö"
                    >
                        <RefreshCw className="w-6 h-6" />
                    </button>
                </div>
            </div>
            );
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SalesDerbyBlue />);
    </script>
</body>
</html>
