<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Derby - ËÜ†ÂéüÈ£õËº™Ë∑ë</title>
    
    <!-- Google Fonts: Fredoka (Cute), Orbitron (Racing), Teko (Numbers) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;600;700&family=Orbitron:wght@400;700;900&family=Teko:wght@300;500;700&display=swap" rel="stylesheet">
    
    <!-- PapaParse for CSV Parsing (if needed for CSV fallback) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'cute': ['"Fredoka"', 'sans-serif'],
                        'racing': ['"Orbitron"', 'sans-serif'],
                        'numbers': ['"Teko"', 'sans-serif'],
                    },
                    colors: {
                        'f1-blue': '#0ea5e9',
                        'f1-cyan': '#22d3ee',
                        'f1-slate': '#0f172a',
                    },
                    animation: {
                        'bounce-slow': 'bounce 2s infinite',
                        'float': 'float 3s ease-in-out infinite',
                        'wiggle': 'wiggle 1s ease-in-out infinite',
                        'pulse-fast': 'pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'shine': 'shine 2s infinite',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-10px)' },
                        },
                        wiggle: {
                            '0%, 100%': { transform: 'rotate(-3deg)' },
                            '50%': { transform: 'rotate(3deg)' },
                        },
                        shine: {
                            '0%': { transform: 'translateX(-100%)' },
                            '100%': { transform: 'translateX(100%)' }
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        /* Cow Bobbing Animation */
        @keyframes gallop {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-5px) rotate(-2deg); }
            75% { transform: translateY(-2px) rotate(2deg); }
        }
        .animate-gallop {
            animation: gallop 0.8s infinite ease-in-out;
        }

        /* --- THEME BACKGROUNDS (MODERN TECH) --- */
        .bg-tech-pattern {
            background-color: #0b1121;
            background-image: 
                linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
            background-size: 30px 30px;
        }
        .bg-asphalt-track {
            background-color: #1e293b;
            background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23334155' fill-opacity='0.4' fill-rule='evenodd'%3E%3Cpath d='M5 0h1L0 6V5zM6 5v1H5z'/%3E%3C/g%3E%3C/svg%3E");
        }
        
        /* Rainbow Text for Unparalleled */
        .text-rainbow {
            background: linear-gradient(to right, #00f3ff, #bc13fe, #0aff68);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            color: transparent;
            font-weight: 900;
            filter: drop-shadow(0px 0px 5px rgba(188, 19, 254, 0.5));
        }
    </style>
</head>
<body class="font-sans selection:bg-neon-blue selection:text-dark-bg overflow-x-hidden text-white">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- CONSTANTS & CONFIGURATION ---
        
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxghoGKevzCyi7UvKx0bzdmSCiOqM_MrP_Z1TLiJhxORi4Oz-6gJHb5oX2e-0b584Ze/exec"; 

        const BRAND_GIFS = {
            "Dermes": "https://i.postimg.cc/DZ0SprZG/DC.gif",
            "Reenex": "https://i.postimg.cc/PxJCVWxw/RC.gif",
            "Elyze": "https://i.postimg.cc/W3zdYG3D/EC.gif"
        };
        const BRAND_COLORS = {
            "Dermes": "#f97316", // Orange
            "Reenex": "#ef4444", // Red
            "Elyze": "#22c55e"   // Green
        };

        const BRANDS = ["Dermes", "Reenex", "Elyze"]; // Defined globally
        const TRACK_TIERS = ["Âü∫Êú¨", "ÂÖ•ÈñÄ", "ÂÖàÈãí", "Â§©Êâç", "Ë∂ÖÁ¥ö", "Ê•µÈôê", "ÂÇ≥Â•á", "Ëàâ‰∏ñÁÑ°Èõô"]; // Defined globally
        const MILES_RANGES = ["0-9", "10-19", "20-29", "30-39", "40-49", "50+"]; // Defined globally - UPDATED RANGES

        // REWARD DATA
        const REWARDS = [
            { miles: 20, title: "20Ëã±Èáå", reward: "CelluionÊ¥ªÊÄßËÜ†ÂéüÂñöËÜöÁµÑÂêà (Mask x 2 + Spray)", icon: "üéÅ", color: "blue" },
            { miles: 30, title: "30Ëã±Èáå", reward: "CelluionÊ¥ªÊÄßËÜ†ÂéüÂñöËÜöÁµÑÂêà (Mask x 4 + Spray) + NeoStrata Êõ¥ÁîüÊ¥ªËÜöÂï´Âñ±Èù¢ËÜú 125ml", icon: "‚ú®", color: "purple" },
            { miles: 40, title: "40Ëã±Èáå", reward: "CelluJet PN+Èõ¢Â≠êËÜ†ÂéüÂÜçÁîüÈù¢ÈÉ®ÁôÇÁ®ã & PLLA 5 Â•óË£ù (ÂêçÈ°çÂçÅ‰Ωç)", icon: "üíÜ‚Äç‚ôÄÔ∏è", color: "pink" },
            { miles: 50, title: "50Ëã±Èáå", reward: "‰∏âÊúàÈ°çÂ§ñ‰∏ÄÂ§©ÂÅáÊúü (ÊúÄÂø´ÂçÅ‰Ωç)", icon: "üèñÔ∏è", color: "green" },
            { miles: 50, title: "50Ëã±Èáå (Top 3)", reward: "Ë∑ëÂæóÊúÄÈÅ†È†≠‰∏âÂêçÈ°çÂ§ñ$1,000ÁèæÈáëÁçé!", icon: "üèÜ", color: "yellow" }
        ];

        const THEME = {
            id: 'MODERN',
            name: 'üöÄ Êú™‰æÜÁ´∂ÈÄü',
            bgClass: 'bg-tech-pattern',
            textMain: 'text-white',
            textSub: 'text-slate-400',
            cardBg: 'bg-slate-800 border border-slate-700 shadow-xl backdrop-blur-md', // Modern dark card
            trackBg: 'bg-asphalt-track',
            trackBorder: 'border-4 border-slate-600', 
            trackHeader: 'bg-slate-900 border-b border-slate-700 text-white',
            laneBorder: 'border-slate-600/50',
            turboColor: '#00f3ff', // Neon Blue
            hudIconColor: 'text-neon-blue',
            milestoneBg: 'bg-slate-700 border-neon-blue'
        };

        // --- GLOBAL HELPERS ---
        const getBrandGif = (brand) => {
            return BRAND_GIFS[brand] || "https://placehold.co/600x338/e2e8f0/64748b?text=Running+Cow";
        };

        const formatMiles = (val) => `${val.toFixed(1)} Ëã±Èáå`;
        const formatCurrency = (val) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'HKD', maximumFractionDigits: 0 }).format(val);

        const getRacerBreakdown = (racer) => {
            if (!racer) return null;
            return {
                pnPaidTrial: racer.trial_qty || 0,
                pnPackage: racer.package_sales || 0, 
                combo: racer.combo_qty || 0,
                plla: racer.plla_qty || 0,
                device: racer.device_qty || 0,
                sub: racer.sub_qty || 0,
                target: racer.sales_target || 0,
                actual: racer.actual_sales || 0,
                achievement_pct: racer.sales_target > 0 ? (racer.actual_sales / racer.sales_target * 100) : 0
            };
        };

        // NEW: Determine Track Level based on %
        const getTrackLevel = (pct) => {
            if (pct >= 160) return { name: "Ëàâ‰∏ñÁÑ°Èõô", color: "text-rainbow", bg: "bg-slate-900/50 border border-purple-500", icon: "üëë" };
            if (pct >= 150) return { name: "ÂÇ≥Â•á", color: "text-yellow-400", bg: "bg-yellow-900/20 border border-yellow-600", icon: "ü¶Ñ" };
            if (pct >= 140) return { name: "Ê•µÈôê", color: "text-red-400", bg: "bg-red-900/20 border border-red-600", icon: "üî•" };
            if (pct >= 130) return { name: "Ë∂ÖÁ¥ö", color: "text-orange-400", bg: "bg-orange-900/20 border border-orange-600", icon: "üöÄ" };
            if (pct >= 120) return { name: "Â§©Êâç", color: "text-purple-400", bg: "bg-purple-900/20 border border-purple-600", icon: "üß†" };
            if (pct >= 110) return { name: "ÂÖàÈãí", color: "text-blue-400", bg: "bg-blue-900/20 border border-blue-600", icon: "üõ°Ô∏è" };
            if (pct >= 100) return { name: "ÂÖ•ÈñÄ", color: "text-green-400", bg: "bg-green-900/20 border border-green-600", icon: "‚úÖ" };
            return { name: "Âü∫Êú¨", color: "text-slate-500", bg: "bg-slate-800/50 border border-slate-700", icon: "üå±" };
        };

        // Fallback Sample Data
        const SAMPLE_RACERS = [
            { id: 1, name: "Sarah Miller", brand: "Dermes", hub: "Kln", floor: "D 35/F TS (A)", nj: "Y", trial_qty: 4, package_sales: 20000, combo_qty: 2, plla_qty: 3, polyca_qty: 3, device_qty: 0, sub_qty: 1, sales: 14.5, sales_target: 200000, actual_sales: 210000 },
            { id: 2, name: "Jessica Wilson", brand: "Reenex", hub: "HK", floor: "R 18/F PP", nj: "N", trial_qty: 10, package_sales: 50000, combo_qty: 5, plla_qty: 6, polyca_qty: 0, device_qty: 1, sub_qty: 2, sales: 49.2, sales_target: 300000, actual_sales: 290000 },
            { id: 3, name: "Elena Rodriguez", brand: "Elyze", hub: "Kln", floor: "E TST", nj: "N", trial_qty: 2, package_sales: 10000, combo_qty: 1, plla_qty: 0, polyca_qty: 3, device_qty: 0, sub_qty: 0, sales: 9.8, sales_target: 150000, actual_sales: 160000 },
            { id: 4, name: "Michelle Chang", brand: "Dermes", hub: "LP 60", floor: "D LP 60 AB", nj: "Y", trial_qty: 6, package_sales: 30000, combo_qty: 3, plla_qty: 3, polyca_qty: 0, device_qty: 1, sub_qty: 1, sales: 28.5, sales_target: 250000, actual_sales: 280000 },
            { id: 5, name: "Anna Patel", brand: "Reenex", hub: "Kln", floor: "R TS", nj: "N", trial_qty: 12, package_sales: 60000, combo_qty: 6, plla_qty: 9, polyca_qty: 6, device_qty: 2, sub_qty: 3, sales: 68.5, sales_target: 400000, actual_sales: 500000 },
            { id: 6, name: "Lisa Wang", brand: "Elyze", hub: "HK", floor: "E PP", nj: "N", trial_qty: 8, package_sales: 40000, combo_qty: 2, plla_qty: 3, polyca_qty: 0, device_qty: 0, sub_qty: 1, sales: 33.0, sales_target: 200000, actual_sales: 180000 },
            { id: 7, name: "Tiffany Baker", brand: "Dermes", hub: "Kln", floor: "D PK", nj: "Y", trial_qty: 2, package_sales: 5000, combo_qty: 1, plla_qty: 0, polyca_qty: 0, device_qty: 0, sub_qty: 0, sales: 8.2, sales_target: 100000, actual_sales: 90000 },
            { id: 8, name: "Kelly Sato", brand: "Reenex", hub: "Kln", floor: "R LP", nj: "N", trial_qty: 4, package_sales: 25000, combo_qty: 2, plla_qty: 0, polyca_qty: 3, device_qty: 0, sub_qty: 0, sales: 19.5, sales_target: 180000, actual_sales: 170000 },
            { id: 9, name: "Amanda Lewis", brand: "Elyze", hub: "Kln", floor: "E TS", nj: "N", trial_qty: 3, package_sales: 15000, combo_qty: 0, plla_qty: 3, polyca_qty: 0, device_qty: 0, sub_qty: 1, sales: 13.0, sales_target: 120000, actual_sales: 130000 },
            { id: 10, name: "Jenny T.", brand: "Dermes", hub: "LP 32", floor: "D LP 32", nj: "Y", trial_qty: 5, package_sales: 22000, combo_qty: 2, plla_qty: 3, polyca_qty: 0, device_qty: 1, sub_qty: 2, sales: 26.0, sales_target: 220000, actual_sales: 240000 }
        ];

        // --- ICONS (SVG Components) ---
        const IconBase = ({ children, className, size = 24, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Trophy = (props) => <IconBase {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const Info = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>;
        const Store = (props) => <IconBase {...props}><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7v3a2 2 0 0 1-2 2v0a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12v0a2 2 0 0 1-2-2V7"/></IconBase>;
        const Award = (props) => <IconBase {...props}><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;
        const Target = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const RefreshCw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></IconBase>;
        const Gift = (props) => <IconBase {...props}><polyline points="20 12 20 22 4 22 4 12" /><rect x="2" y="7" width="20" height="5" /><line x1="12" y1="22" x2="12" y2="7" /><path d="M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z" /><path d="M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z" /></IconBase>;
        const Calendar = (props) => <IconBase {...props}><rect x="3" y="4" width="18" height="18" rx="2" ry="2" /><line x1="16" y1="2" x2="16" y2="6" /><line x1="8" y1="2" x2="8" y2="6" /><line x1="3" y1="10" x2="21" y2="10" /></IconBase>;
        const Building = (props) => <IconBase {...props}><rect x="4" y="2" width="16" height="20" rx="2" ry="2" /><line x1="9" y1="22" x2="9" y2="22.01" /><line x1="15" y1="22" x2="15" y2="22.01" /><line x1="12" y1="22" x2="12" y2="22.01" /><line x1="12" y1="2" x2="12" y2="4" /><line x1="4" y1="6" x2="20" y2="6" /><line x1="4" y1="10" x2="20" y2="10" /><line x1="4" y1="14" x2="20" y2="14" /><line x1="4" y1="18" x2="20" y2="18" /></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></IconBase>;
        const MapPin = (props) => <IconBase {...props}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" /><circle cx="12" cy="10" r="3" /></IconBase>;
        const Tag = (props) => <IconBase {...props}><path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z" /><line x1="7" y1="7" x2="7.01" y2="7" /></IconBase>;
        const Repeat = (props) => <IconBase {...props}><polyline points="17 1 21 5 17 9" /><path d="M3 11V9a4 4 0 0 1 4-4h14" /><polyline points="7 23 3 19 7 15" /><path d="M21 13v2a4 4 0 0 1-4 4H3" /></IconBase>;
        const Star = (props) => <IconBase {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" /></IconBase>;

        // --- VISUAL COMPONENTS ---

        const F1Card = ({ children, className = "", theme }) => (
            <div className={`${theme.cardBg} rounded-2xl overflow-hidden relative group hover:scale-[1.01] transition-all duration-300 ${className}`}>
                {children}
            </div>
        );
        
        // --- MULTI-SELECT COMPONENT ---
        const MultiSelectDropdown = ({ label, options, selected, onChange, theme }) => {
            const [isOpen, setIsOpen] = useState(false);
            const containerRef = useRef(null);

            // Close on click outside
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (containerRef.current && !containerRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener("mousedown", handleClickOutside);
                return () => document.removeEventListener("mousedown", handleClickOutside);
            }, []);

            const toggleOption = (val) => {
                let newSelected;
                if (val === "ALL") {
                    newSelected = ["ALL"];
                } else {
                    // If ALL was selected, remove it
                    let temp = selected.filter(s => s !== "ALL");
                    if (temp.includes(val)) {
                        temp = temp.filter(item => item !== val);
                    } else {
                        temp.push(val);
                    }
                    // If nothing left, revert to ALL
                    newSelected = temp.length === 0 ? ["ALL"] : temp;
                }
                onChange(newSelected);
            };

            const displayValue = selected.includes("ALL") ? "ÂÖ®ÈÉ®" : `${selected.length} Â∑≤ÈÅ∏`;

            return (
                <div className="relative" ref={containerRef}>
                    <button 
                        onClick={() => setIsOpen(!isOpen)}
                        className={`flex items-center justify-between gap-2 px-3 py-1.5 rounded-lg border ${theme.id === 'MODERN' ? 'bg-slate-900 border-slate-700 text-slate-300 hover:border-slate-500' : 'bg-white border-slate-200 text-slate-700'} text-xs font-bold min-w-[120px] transition-colors`}
                    >
                        <span className="truncate">{label}: {displayValue}</span>
                        <span className="text-[10px]">‚ñº</span>
                    </button>
                    
                    {isOpen && (
                        <div className={`absolute top-full left-0 mt-1 w-48 max-h-60 overflow-y-auto rounded-lg border shadow-xl z-[100] ${theme.id === 'MODERN' ? 'bg-slate-800 border-slate-600' : 'bg-white border-slate-200'}`}>
                            <div 
                                className={`px-3 py-2 cursor-pointer hover:bg-opacity-20 hover:bg-gray-500 flex items-center gap-2 ${selected.includes("ALL") ? (theme.id==='MODERN' ? 'text-neon-blue' : 'text-blue-600') : (theme.id==='MODERN' ? 'text-slate-400' : 'text-slate-600')}`}
                                onClick={() => { toggleOption("ALL"); setIsOpen(false); }}
                            >
                                <div className={`w-3 h-3 rounded-sm border flex items-center justify-center ${selected.includes("ALL") ? 'bg-current border-current' : 'border-gray-500'}`}>
                                    {selected.includes("ALL") && <div className="w-1.5 h-1.5 bg-slate-900 rounded-[1px]"></div>}
                                </div>
                                <span className="text-xs font-bold">ÂÖ®ÈÉ® (All)</span>
                            </div>
                            {options.map(opt => (
                                <div 
                                    key={opt}
                                    className={`px-3 py-2 cursor-pointer hover:bg-opacity-20 hover:bg-gray-500 flex items-center gap-2 ${selected.includes(opt) ? (theme.id==='MODERN' ? 'text-neon-blue' : 'text-blue-600') : (theme.id==='MODERN' ? 'text-slate-400' : 'text-slate-600')}`}
                                    onClick={() => toggleOption(opt)}
                                >
                                    <div className={`w-3 h-3 rounded-sm border flex items-center justify-center ${selected.includes(opt) ? 'bg-current border-current' : 'border-gray-500'}`}>
                                        {selected.includes(opt) && <div className="w-1.5 h-1.5 bg-slate-900 rounded-[1px]"></div>}
                                    </div>
                                    <span className="text-xs font-bold truncate">{opt}</span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        // --- COMPONENT: IMPACTFUL STRAIGHT TRACK (TOP 15 - 5 per Brand) ---
        const ImpactfulStraightTrack = ({ data, title, theme, height = "auto" }) => {
            const maxSales = Math.max(...data.map(r => r.sales), 10); 
            // Scale ensuring landmarks visible (at least 85 miles now, or leader * 1.35)
            const trackMax = Math.max(maxSales * 1.35, 85); 
            
            const formatMiles = (val) => `${val.toFixed(1)} Ëã±Èáå`;
            // getBrandGif is global

            const racerCount = data.length || 1;
            // Compact Mode: Reduce lane height to 65px per racer (approx) - MORE COMPACT
            // Minimum track height 300px
            const LANE_HEIGHT = 70;
            // Space between turf and lanes - COMPACT
            const VERTICAL_PADDING = 60;

            const computedHeight = Math.max((racerCount * LANE_HEIGHT) + (VERTICAL_PADDING * 2), 300);
            
            return (
                /* Main Track Container - rounded-3xl for cute look */
                <div className={`rounded-3xl overflow-hidden ${theme.trackBorder} shadow-2xl relative transition-colors duration-500 bg-slate-900`}>
                    
                    {/* Header */}
                    <div className={`${theme.trackHeader} p-6 flex flex-col md:flex-row justify-between items-center relative z-30 shadow-lg`}>
                        <h2 className="text-2xl md:text-3xl font-cute font-bold flex items-center tracking-wide mb-2 md:mb-0">
                        <span className="mr-3 text-4xl animate-bounce">üèÅ</span> {title}
                        </h2>
                        <div className="text-lg font-cute font-bold bg-slate-800/50 px-6 py-2 rounded-full backdrop-blur-sm border border-slate-600 shadow-sm text-slate-300">
                            Ë≥ΩÁ®ãÁØÑÂúç: 0 - {formatMiles(trackMax)}
                        </div>
                    </div>
                    
                    {/* Track Area */}
                    <div className={`relative w-full ${theme.trackBg} transition-colors duration-500`} style={{ height: `${computedHeight}px` }}>
                        
                        {/* 1. Track Surface & Racers (CLIPPED) */}
                        <div className="absolute inset-0 overflow-hidden">
                             {/* Spectator Stands/Turf Top */}
                             <div className={`absolute top-0 left-0 right-0 h-16 bg-slate-800 z-10 border-b-4 border-slate-600 shadow-inner`}></div>
                             
                             {/* Spectator Stands/Turf Bottom */}
                             <div className={`absolute bottom-0 left-0 right-0 h-16 bg-slate-800 z-10 border-t-4 border-slate-600 shadow-inner`}></div>
                             
                             {/* Lanes */}
                             {Array.from({length: racerCount}).map((_, i) => (
                                <div key={i} className={`absolute w-full border-b border-dashed ${theme.laneBorder}`} 
                                     style={{ top: `${VERTICAL_PADDING + (i * LANE_HEIGHT)}px`, height: `${LANE_HEIGHT}px` }}></div>
                             ))}
                             
                             {/* Fixed Left Ranking Column */}
                             <div className="absolute left-4 top-0 bottom-0 w-12 z-30 pointer-events-none">
                                {Array.from({length: racerCount}).map((_, i) => (
                                    <div 
                                        key={i} 
                                        className="absolute left-0 w-full flex items-center justify-center"
                                        style={{ 
                                            top: `${VERTICAL_PADDING + (i * LANE_HEIGHT)}px`, 
                                            height: `${LANE_HEIGHT}px` 
                                        }}
                                    >
                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-lg font-bold text-white shadow-lg border-2
                                            ${i === 0 ? 'bg-yellow-500 border-yellow-300 scale-125 z-10' : 
                                              i === 1 ? 'bg-slate-500 border-slate-300' : 
                                              i === 2 ? 'bg-orange-700 border-orange-500' : 'bg-slate-700 border-slate-600 opacity-60'}`}>
                                            {i + 1}
                                        </div>
                                    </div>
                                ))}
                             </div>
                             
                             {/* Start Line Grid */}
                             <div className="absolute left-16 w-12 z-0 flex flex-col justify-center items-center opacity-40"
                                  style={{ top: `${VERTICAL_PADDING}px`, bottom: `${VERTICAL_PADDING}px` }}>
                                <div className="w-full h-full" style={{ backgroundImage: 'linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%), linear-gradient(45deg, #fff 25%, transparent 25%, transparent 75%, #fff 75%)', backgroundSize: '10px 10px', backgroundPosition: '0 0, 5px 5px' }}></div>
                                <div className={`absolute transform -rotate-90 text-white font-racing font-bold text-2xl tracking-widest whitespace-nowrap drop-shadow-md`}>START</div>
                             </div>
                            <div className="absolute inset-0 pointer-events-none pl-14"> 
                                {data.map((racer, index) => {
                                    const progress = Math.min((racer.sales / trackMax) * 100, 95); 
                                    const leftPos = progress * 0.9;
                                    
                                    const isNearEnd = progress > 55;
                                    const labelClass = isNearEnd 
                                        ? "right-full mr-6 flex-row-reverse" 
                                        : "left-full ml-6";

                                    // Achievement % and Level for Badge
                                    const achPct = racer.sales_target > 0 ? (racer.actual_sales / racer.sales_target * 100) : 0;
                                    const trackLevel = getTrackLevel(achPct);

                                    let trailColor = "from-transparent to-white";
                                    if (racer.brand === "Dermes") trailColor = "from-transparent via-orange-500 to-orange-200";
                                    if (racer.brand === "Reenex") trailColor = "from-transparent via-red-600 to-red-400";
                                    if (racer.brand === "Elyze") trailColor = "from-transparent via-emerald-500 to-emerald-200";

                                    return (
                                        <div 
                                            key={racer.id} 
                                            className="absolute w-full group z-20 hover:z-50 pointer-events-auto"
                                            style={{ 
                                                top: `${VERTICAL_PADDING + (index * LANE_HEIGHT)}px`, 
                                                height: `${LANE_HEIGHT}px` 
                                            }}
                                        >
                                            <div className="relative w-full h-full flex items-center">
                                                
                                                {/* TRACK TIER WATERMARK (ON TRACK - CENTERED) */}
                                                {/* Adjusted: Centered to prevent going off-screen */}
                                                <div className={`absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 text-4xl md:text-7xl font-black italic tracking-tighter opacity-40 pointer-events-none whitespace-nowrap z-0 ${trackLevel.color} font-racing`} 
                                                     style={{ textShadow: '0 2px 10px rgba(0,0,0,0.5)' }}>
                                                    {trackLevel.icon} {trackLevel.name}Ë∑ëÈÅì
                                                </div>

                                                <div 
                                                    className="absolute transform -translate-x-1/2 -translate-y-1/2 transition-all duration-1000 ease-linear flex items-center group-hover:z-[100]"
                                                    style={{ left: `${leftPos}%`, top: '50%' }}
                                                >
                                                    {/* Neon Trail */}
                                                    <div className={`absolute right-8 top-1/2 -translate-y-1/2 -z-10`}>
                                                        <div className={`h-1 w-32 bg-gradient-to-r from-transparent to-cyan-500 rounded-full blur-[1px] opacity-80`}></div>
                                                    </div>

                                                    {/* Cow with Bobbing Animation */}
                                                    <div className="relative z-30 transform cursor-pointer animate-gallop hover:scale-110 transition-transform">
                                                        <div className="absolute -inset-4 bg-cyan-500/20 rounded-full blur-lg animate-pulse -z-10"></div>
                                                        <img 
                                                            src={getBrandGif(racer.brand)} 
                                                            alt={racer.name} 
                                                            className={`h-12 md:h-16 w-auto object-contain filter drop-shadow-[0_0_10px_rgba(0,0,0,0.8)] ${index===0 ? 'scale-110' : ''}`}
                                                        />
                                                        
                                                        {/* Modern Name Tag Bubble */}
                                                        <div className={`absolute ${labelClass} bg-slate-900/90 text-white px-2 py-1 md:px-3 md:py-1.5 rounded-lg text-[10px] md:text-xs font-bold shadow-lg border border-slate-600 z-[60] backdrop-blur-md transition-all whitespace-nowrap min-w-max group-hover:scale-110 top-1/2 -translate-y-1/2 flex items-center gap-2`}>
                                                            <span className={isNearEnd ? "ml-1 order-2" : "mr-1"}>{racer.name.split(' ')[0]}</span>
                                                            <span className={`text-cyan-400 font-numbers text-sm`}>{formatMiles(racer.sales)}</span>
                                                            
                                                            {/* Track Level Badge (Small) */}
                                                            {achPct >= 100 && (
                                                                <span className={`ml-1 px-1.5 py-0.5 rounded-md bg-slate-800 border ${trackLevel.color.replace('text-', 'border-')} text-[8px] ${trackLevel.color} ${isNearEnd ? "order-first mr-1" : ""}`}>
                                                                    {trackLevel.icon}
                                                                </span>
                                                            )}
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>

                        {/* 2. Milestones (Neon Markers) */}
                        <div className="absolute inset-0 pointer-events-none pl-14">
                            {[20, 40, 60].map((mile, idx) => {
                                const pct = (mile / trackMax) * 100;
                                if (pct > 95) return null; 

                                const isTop = idx % 2 === 0;
                                const labelPositionClass = isTop 
                                    ? "-top-12"
                                    : "top-full mt-12";

                                return (
                                    <div key={mile} className="absolute w-1 z-40 pointer-events-none" 
                                         style={{ 
                                             left: `${pct * 0.9}%`, 
                                             top: `${VERTICAL_PADDING}px`,
                                             bottom: `${VERTICAL_PADDING}px`
                                         }}>
                                        
                                        {/* Neon Line */}
                                        <div className={`h-full w-px bg-cyan-500/30 shadow-[0_0_10px_#00f3ff]`}></div>
                                        
                                        {/* Floating Label - Neon Sign */}
                                        <div className={`absolute ${labelPositionClass} -left-20 w-40 flex flex-col items-center z-50`}>
                                            <div className={`relative bg-slate-900/90 border border-cyan-500/50 text-cyan-400 font-racing font-bold py-1 px-4 rounded shadow-[0_0_15px_rgba(0,243,255,0.3)] text-center transform hover:scale-110 transition-transform`}>
                                                <span className="text-lg">{mile}</span> <span className="text-xs opacity-70">MILES</span>
                                            </div>
                                        </div>
                                    </div>
                                );
                            })}
                        </div>
                    </div>
                </div>
            );
        };

        // --- MAIN COMPONENT ---

        function SalesDerbyBlue() {
            const [racers, setRacers] = useState(SAMPLE_RACERS);
            const [isLoading, setIsLoading] = useState(false);
            const [lastUpdated, setLastUpdated] = useState(null);
            const [fetchError, setFetchError] = useState(false);
            
            // Scorecard State
            const [scBrand, setScBrand] = useState("ALL");
            const [scHub, setScHub] = useState("ALL");
            const [scFloor, setScFloor] = useState("ALL");
            const [scRacerId, setScRacerId] = useState("");

            // Leaderboard State
            const [leaderboardView, setLeaderboardView] = useState("BRAND"); 
            const [lbNJFilter, setLbNJFilter] = useState("ALL"); 
            const [lbTierFilter, setLbTierFilter] = useState("ALL"); // NEW TIER FILTER
            
            // MASTER BRAND FILTER (Applies to all stats below)
            const [masterBrandFilter, setMasterBrandFilter] = useState("ALL");
            
            // Filter states for dropdowns
            const [floorHubFilter, setFloorHubFilter] = useState("ALL");
            const [floorLevelFilter, setFloorLevelFilter] = useState("ALL");
            
            // Track Filter States (ARRAY FOR MULTI-SELECT)
            const [trackFilterBrand, setTrackFilterBrand] = useState(["ALL"]);
            const [trackFilterHub, setTrackFilterHub] = useState(["ALL"]);
            const [trackFilterFloor, setTrackFilterFloor] = useState(["ALL"]);
            const [trackFilterTier, setTrackFilterTier] = useState(["ALL"]);
            // Miles Filter (NEW - Multi Select)
            const [trackFilterMiles, setTrackFilterMiles] = useState(["ALL"]);

            const theme = THEME; 

            // Derived Lists
            const uniqueHubs = useMemo(() => {
                let filtered = racers;
                if (scBrand !== "ALL") filtered = filtered.filter(r => r.brand === scBrand);
                return [...new Set(filtered.map(r => r.hub))].sort();
            }, [racers, scBrand]);
            
            const uniqueFloors = useMemo(() => {
                let filtered = racers;
                if (scBrand !== "ALL") filtered = filtered.filter(r => r.brand === scBrand);
                if (scHub !== "ALL") filtered = filtered.filter(r => r.hub === scHub);
                return [...new Set(filtered.map(r => r.floor))].sort();
            }, [racers, scBrand, scHub]);

            const uniqueFloorHubs = useMemo(() => {
                 let filtered = racers;
                 if (masterBrandFilter !== "ALL") filtered = filtered.filter(r => r.brand === masterBrandFilter);
                 return [...new Set(filtered.map(r => r.hub))].sort();
            }, [racers, masterBrandFilter]);

            const uniqueFloorLevels = useMemo(() => {
                let filtered = racers;
                if (masterBrandFilter !== "ALL") filtered = filtered.filter(r => r.brand === masterBrandFilter);
                if (floorHubFilter !== "ALL") filtered = filtered.filter(r => r.hub === floorHubFilter);
                return [...new Set(filtered.map(r => r.floor))].sort();
            }, [racers, masterBrandFilter, floorHubFilter]);
            
            // Derived Lists for Track Filters (UPDATED FOR MULTI-SELECT)
            const uniqueTrackHubs = useMemo(() => {
                let filtered = racers;
                // Filter by Brand array
                if (!trackFilterBrand.includes("ALL")) {
                    filtered = filtered.filter(r => trackFilterBrand.includes(r.brand));
                }
                return [...new Set(filtered.map(r => r.hub))].sort();
            }, [racers, trackFilterBrand]);

            const uniqueTrackFloors = useMemo(() => {
                let filtered = racers;
                if (!trackFilterBrand.includes("ALL")) {
                    filtered = filtered.filter(r => trackFilterBrand.includes(r.brand));
                }
                if (!trackFilterHub.includes("ALL")) {
                    filtered = filtered.filter(r => trackFilterHub.includes(r.hub));
                }
                return [...new Set(filtered.map(r => r.floor))].sort();
            }, [racers, trackFilterBrand, trackFilterHub]);
            
            // Define scAvailableRacers
            const scAvailableRacers = useMemo(() => {
                return racers.filter(r => {
                    const matchBrand = scBrand === "ALL" || r.brand === scBrand;
                    const matchHub = scHub === "ALL" || r.hub === scHub;
                    const matchFloor = scFloor === "ALL" || r.floor === scFloor;
                    return matchBrand && matchHub && matchFloor;
                }).sort((a, b) => a.name.localeCompare(b.name));
            }, [racers, scBrand, scHub, scFloor]);

            useEffect(() => {
                if (scAvailableRacers.length > 0) {
                    const exists = scAvailableRacers.find(r => r.id.toString() === scRacerId);
                    if (!exists) setScRacerId(scAvailableRacers[0].id.toString());
                } else { setScRacerId(""); }
            }, [scAvailableRacers, scRacerId]);

            const fetchData = () => {
                if (!GOOGLE_SCRIPT_URL) return;
                setIsLoading(true);
                setFetchError(false);
                fetch(GOOGLE_SCRIPT_URL, { method: 'GET', redirect: 'follow' })
                .then(response => { if (!response.ok) throw new Error(`HTTP error!`); return response.json(); })
                .then(data => {
                    if (data && data.length > 0) {
                        const normalizeKeys = (obj) => {
                            const newObj = {};
                            Object.keys(obj).forEach(key => { newObj[key.toLowerCase().replace(/[\s_]/g, '')] = obj[key]; });
                            return newObj;
                        };
                        const parseNum = (val) => {
                            if (typeof val === 'number') return val;
                            if (typeof val === 'string') return parseFloat(val.replace(/[$,]/g, '')) || 0;
                            return 0;
                        };
                        const normalizeBrand = (str) => {
                            if (!str) return null;
                            const lower = str.trim().toLowerCase();
                            if (lower.includes('dermes') || lower.startsWith('d')) return 'Dermes';
                            if (lower.includes('reenex') || lower.startsWith('r')) return 'Reenex';
                            if (lower.includes('elyze') || lower.startsWith('e')) return 'Elyze';
                            return null;
                        };
                        const deriveBrand = (str) => {
                            if (!str) return "Unknown";
                            const firstChar = str.trim().charAt(0).toUpperCase();
                            if (firstChar === 'D') return 'Dermes';
                            if (firstChar === 'R') return 'Reenex';
                            if (firstChar === 'E') return 'Elyze';
                            return "Unknown";
                        }
                        const deriveHub = (str, brand) => {
                            if (!str) return "General";
                            const s = str.toUpperCase();
                            if (brand === 'Dermes' && s.includes('LP')) {
                                if (s.includes('60')) return 'LP 60';
                                if (s.includes('32')) return 'LP 32';
                            }
                            if (s.includes('TS')) return 'TS';
                            if (s.includes('LP')) return 'LP';
                            if (s.includes('PP')) return 'PP';
                            if (s.includes('TST') || s.includes('PK') || s.includes('RD')) return 'TST';
                            return "General";
                        }
                        const newRacers = data.map((row) => normalizeKeys(row)).filter(row => row.name).map((row, index) => {
                            const trialQty = parseNum(row.trialqty);
                            const packageSales = parseNum(row.packagesales);
                            const comboQty = parseNum(row.comboqty);
                            const pllaQty = parseNum(row.pllaqty);
                            const deviceQty = parseNum(row.deviceqty);
                            const subQty = parseNum(row.subqty); 
                            
                            // UPDATED: Check multiple possible column names for Target and Actual Sales
                            const salesTarget = parseNum(row.salestarget) || parseNum(row.target) || parseNum(row.sales_target) || 200000; 
                            const actualSales = parseNum(row.actualsales) || parseNum(row.actualsale) || parseNum(row.actual_sales) || 0;
                            
                            const milesTrial = trialQty * 2; 
                            const milesPackage = Math.floor(packageSales / 10000) * 2; 
                            const milesCombo = comboQty * 4; 
                            const milesPlla = Math.floor(pllaQty / 2) * 2; 
                            const milesDevice = deviceQty * 3; 
                            const milesSub = subQty * 2;
                            
                            const totalMiles = milesTrial + milesPackage + milesCombo + milesPlla + milesDevice + milesSub;
                            
                            const njValue = row.nj ? row.nj.toUpperCase() : 'N';
                            let rawFloorStr = row.floor || row.shop || "HQ";
                            
                            let brand = normalizeBrand(row.brand);
                            if (!brand) brand = deriveBrand(rawFloorStr);
                            
                            let hub = row.hub;
                            let derivedHub = deriveHub(rawFloorStr, brand);
                            if (brand === 'Dermes' && (derivedHub === 'LP 60' || derivedHub === 'LP 32')) {
                                hub = derivedHub;
                            } else if (!hub) {
                                hub = derivedHub;
                            }
                            return {
                                id: index + 1, name: row.name, brand: brand, hub: hub, floor: rawFloorStr, nj: njValue,
                                trial_qty: trialQty, package_sales: packageSales, combo_qty: comboQty, plla_qty: pllaQty, device_qty: deviceQty, sub_qty: subQty,
                                sales: totalMiles, color: BRAND_COLORS[brand] || "#94a3b8",
                                sales_target: salesTarget, actual_sales: actualSales
                            };
                        });
                        setRacers(newRacers); setLastUpdated(new Date()); setFetchError(false);
                    }
                    setIsLoading(false);
                })
                .catch(err => { setFetchError(true); setIsLoading(false); });
            };

            useEffect(() => { fetchData(); const interval = setInterval(fetchData, 30000); return () => clearInterval(interval); }, []);

            const sortedGlobal = useMemo(() => [...racers].sort((a, b) => b.sales - a.sales), [racers]);
            const top3 = sortedGlobal.slice(0, 3);
            
            // --- FILTERED DATA FOR ALL SECTIONS ---
            const filteredRacers = useMemo(() => {
                if (masterBrandFilter === "ALL") return racers;
                return racers.filter(r => r.brand === masterBrandFilter);
            }, [racers, masterBrandFilter]);
            
            // Track Data Calculation (Using TRACK filters - Multi Select)
            const trackRacers = useMemo(() => {
                let filtered = racers.filter(r => {
                    // Check Brand
                    if (!trackFilterBrand.includes("ALL") && !trackFilterBrand.includes(r.brand)) return false;
                    
                    // Check Hub
                    if (!trackFilterHub.includes("ALL") && !trackFilterHub.includes(r.hub)) return false;
                    
                    // Check Floor
                    if (!trackFilterFloor.includes("ALL") && !trackFilterFloor.includes(r.floor)) return false;
                    
                    // Check Tier
                    if (!trackFilterTier.includes("ALL")) {
                        const achPct = r.sales_target > 0 ? (r.actual_sales / r.sales_target * 100) : 0;
                        const level = getTrackLevel(achPct).name;
                        if (!trackFilterTier.includes(level)) return false;
                    }

                    // Check Miles Filter (NEW - Multi Select Logic)
                    if (!trackFilterMiles.includes("ALL")) {
                         const matchesAnyRange = trackFilterMiles.some(range => {
                             if (range.endsWith('+')) {
                                 const min = parseInt(range);
                                 return r.sales >= min;
                             } else {
                                 const [min, max] = range.split('-').map(Number);
                                 return r.sales >= min && r.sales <= max;
                             }
                         });
                         if (!matchesAnyRange) return false;
                    }

                    return true;
                });

                filtered.sort((a, b) => b.sales - a.sales);
                return filtered.slice(0, 15);
            }, [racers, trackFilterBrand, trackFilterHub, trackFilterFloor, trackFilterTier, trackFilterMiles]);

            // --- LEADERBOARD STATS ---
            const filterByNJ = (r) => lbNJFilter === 'ALL' || r.nj === lbNJFilter;
            
            // NEW: Filter by Tier helper
            const filterByTier = (r) => {
                if (lbTierFilter === 'ALL') return true;
                const achPct = r.sales_target > 0 ? (r.actual_sales / r.sales_target * 100) : 0;
                const levelName = getTrackLevel(achPct).name;
                return levelName === lbTierFilter;
            };

            const filterRacersForLeaderboard = (r) => {
                // Must pass NJ, Tier filters AND respect Master Brand
                if (!filterByNJ(r)) return false;
                if (!filterByTier(r)) return false;
                if (masterBrandFilter !== "ALL" && r.brand !== masterBrandFilter) return false;
                return true;
            };

            // 1. BRAND STATS
            const brandStats = useMemo(() => {
                const map = {};
                racers.filter(filterRacersForLeaderboard).forEach(r => {
                    if (!map[r.brand]) map[r.brand] = { name: r.brand, miles: 0, count: 0, color: BRAND_COLORS[r.brand] };
                    map[r.brand].miles += r.sales;
                    map[r.brand].count += 1;
                });
                return Object.values(map).sort((a, b) => b.miles - a.miles);
            }, [racers, lbNJFilter, lbTierFilter, masterBrandFilter]); // Added all dependencies

            // 2. HUB STATS
            const hubStats = useMemo(() => {
                const map = {};
                filteredRacers.filter(filterRacersForLeaderboard).forEach(r => {
                    const hubName = r.hub || "Unknown";
                    // If showing ALL brands, split Hubs by brand (e.g. Dermes Kln vs Reenex Kln)
                    // If showing ONE brand, just show Hubs for that brand
                    const key = masterBrandFilter === "ALL" ? `${r.brand} - ${hubName}` : hubName;
                    
                    if (!map[key]) {
                        map[key] = { 
                            name: hubName, 
                            displayName: masterBrandFilter === "ALL" ? `${r.brand} ${hubName}` : hubName,
                            miles: 0, 
                            count: 0, 
                            brand: r.brand 
                        };
                    }
                    map[key].miles += r.sales;
                    map[key].count += 1;
                });
                return Object.values(map).sort((a, b) => b.miles - a.miles);
            }, [filteredRacers, lbNJFilter, lbTierFilter, masterBrandFilter]);

            // 3. FLOOR STATS
            const floorStats = useMemo(() => {
                const map = {};
                filteredRacers.filter(filterRacersForLeaderboard).forEach(r => {
                    const key = r.floor; // Floor names are usually unique enough (e.g. D 35/F TS (A))
                    if (!map[key]) {
                        map[key] = { 
                            name: r.floor, 
                            displayName: r.floor,
                            miles: 0, 
                            count: 0, 
                            brand: r.brand,
                            hub: r.hub 
                        };
                    }
                    map[key].miles += r.sales;
                    map[key].count += 1;
                });
                return Object.values(map).sort((a, b) => b.miles - a.miles);
            }, [filteredRacers, lbNJFilter]);

            const getBrandColorClass = (b) => {
                if (b === 'Dermes') return 'bg-orange-500';
                if (b === 'Reenex') return 'bg-red-600';
                if (b === 'Elyze') return 'bg-green-600';
                return 'bg-slate-400'; // Default gray for Unknown
            };

            const renderLeaderboardCard = (item, idx, type) => {
                // Dynamic max for bar chart
                const list = type === 'BRAND' ? brandStats : type === 'HUB' ? hubStats : floorStats;
                const maxMiles = Math.max(...list.map(i => i.miles), 1);
                const percentage = (item.miles / maxMiles) * 100;
                
                let badgeColor = 'bg-slate-200 text-slate-500';
                if (idx === 0) badgeColor = 'bg-yellow-400 text-yellow-900';
                if (idx === 1) badgeColor = 'bg-slate-400 text-white';
                if (idx === 2) badgeColor = 'bg-orange-400 text-white';
                
                let barColor = 'bg-slate-400';
                if (item.brand === 'Dermes') barColor = 'bg-orange-400';
                if (item.brand === 'Reenex') barColor = 'bg-red-500';
                if (item.brand === 'Elyze') barColor = 'bg-green-500';

                return (
                    <F1Card key={`${type}_${item.name}_${item.brand || ''}`} theme={theme} className="p-4 hover:-translate-y-1 hover:shadow-cyan-500/20 transition-all relative overflow-hidden group bg-slate-800 border border-slate-700">
                         <div className="absolute top-0 right-0 p-2 opacity-5"><Trophy size={80} className="text-white" /></div>
                        <div className="relative z-10">
                            <div className="flex justify-between items-start mb-2">
                                <div className="flex items-center gap-3">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm shadow-lg ${badgeColor}`}>{idx + 1}</div>
                                    <div>
                                        <h4 className="font-bold text-lg text-white leading-none flex items-center gap-2 font-racing tracking-wide">
                                            {item.displayName || item.name}
                                        </h4>
                                        {/* Display Brand Badge only if showing ALL brands to distinguish */}
                                        {masterBrandFilter === "ALL" && type !== 'BRAND' && (
                                            <div className="mt-1">
                                                <span className={`text-[10px] font-bold uppercase px-2 py-0.5 rounded text-white ${getBrandColorClass(item.brand)}`}>
                                                    {item.brand}
                                                </span>
                                            </div>
                                        )}
                                        {type === 'FLOOR' && <div className="mt-0.5 text-[10px] text-slate-400 font-bold uppercase tracking-wider">{item.hub}</div>}
                                    </div>
                                </div>
                                <div className="text-xs font-bold text-slate-300 bg-slate-700/50 px-2 py-0.5 rounded-full whitespace-nowrap border border-slate-600">{item.count} ‰∫∫</div>
                            </div>
                            <div className="flex items-end justify-between mb-2">
                                <div className="text-3xl font-numbers font-bold text-white">{item.miles.toFixed(1)} <span className="text-sm text-slate-400 font-bold font-sans">MILES</span></div>
                                {type === 'BRAND' && <img src={getBrandGif(item.name)} className="h-8 w-auto object-contain" />}
                            </div>
                            <div className="w-full bg-slate-700 h-2 rounded-full overflow-hidden border border-slate-600"><div className={`h-full rounded-full ${barColor} shadow-[0_0_10px_currentColor]`} style={{ width: `${percentage}%` }}></div></div>
                        </div>
                    </F1Card>
                );
            };

            const dermesTotal = racers.filter(r => r.brand === 'Dermes').reduce((a, b) => a + b.sales, 0);
            const reenexTotal = racers.filter(r => r.brand === 'Reenex').reduce((a, b) => a + b.sales, 0);
            const elyzeTotal = racers.filter(r => r.brand === 'Elyze').reduce((a, b) => a + b.sales, 0);
            const grandTotal = dermesTotal + reenexTotal + elyzeTotal || 1; 
            const dermesPct = (dermesTotal / grandTotal) * 100;
            const reenexPct = (reenexTotal / grandTotal) * 100;
            const elyzePct = (elyzeTotal / grandTotal) * 100;

            const activeRacersCount = filteredRacers.filter(r => r.sales > 0).length;

            useEffect(() => {
                if (scAvailableRacers.length > 0) {
                    const exists = scAvailableRacers.find(r => r.id.toString() === scRacerId);
                    if (!exists) setScRacerId(scAvailableRacers[0].id.toString());
                } else { setScRacerId(""); }
            }, [scAvailableRacers, scRacerId]);

            return (
                <div className={`min-h-screen ${theme.bgClass} font-sans selection:bg-neon-blue selection:text-dark-bg relative transition-colors duration-1000 text-slate-200`}>
                <section className="relative w-full bg-slate-900 shadow-xl z-20 border-b border-slate-700">
                    <div className="w-full"><img src="https://i.postimg.cc/4xWSKVQ8/dreamina-2026-01-30-9978-Transform-the-curved-golden-running-tra-(1).jpg" alt="Main Event Poster" className="w-full h-auto object-cover block opacity-80 hover:opacity-100 transition-opacity" /></div>
                </section>
                <main className="max-w-7xl mx-auto p-4 md:p-8 space-y-16 pb-24">
                    <section className="w-full">
                        <div className="text-center mb-8">
                            <h1 className={`text-5xl md:text-7xl font-racing font-bold text-transparent bg-clip-text bg-gradient-to-r from-neon-blue via-white to-neon-purple drop-shadow-[0_0_10px_rgba(0,243,255,0.5)] mb-4 italic`}>ËÜ†ÂéüÈ£õËº™Ë∑ë üêÆ</h1>
                            <div className="inline-block bg-slate-800/80 text-neon-blue px-8 py-2 rounded-full border border-neon-blue shadow-[0_0_15px_rgba(0,243,255,0.3)] transform -skew-x-12 hover:skew-x-0 transition-transform"><span className="block text-xl md:text-2xl font-bold tracking-widest skew-x-12 hover:skew-x-0">ÂÖ®Ê∞ëÁ´∂Ë∑ë„ÄÇ‰∫∫‰∫∫ÊØèÊó•‰∫åÂçÅËã±Èáå</span></div>
                        </div>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                             <F1Card theme={theme} className="p-5 flex flex-col justify-between h-full bg-slate-800 relative overflow-hidden">
                                <div className={`absolute -right-10 -top-10 w-40 h-40 rounded-full blur-[100px] opacity-20 bg-neon-blue`}></div>
                                <div className="flex justify-between items-start relative z-10 mb-2">
                                    <div>
                                        <h3 className={`text-slate-400 text-sm font-bold tracking-widest uppercase mb-1`}>Á∏ΩÁç≤ÂæóËã±Èáå</h3>
                                        <div className={`text-7xl font-numbers font-bold text-white leading-none tracking-tight drop-shadow-lg`}>{filteredRacers.reduce((a,b)=>a+b.sales,0).toFixed(1)}<span className="text-xl ml-1 font-bold text-slate-500">MILES</span></div>
                                    </div>
                                    <div className={`p-3 rounded-2xl shadow-lg bg-slate-700/50 text-neon-blue border border-slate-600`}><Award className="animate-pulse" size={28} /></div>
                                </div>
                                <div className="w-full h-2 rounded-full overflow-hidden mb-4 bg-slate-700 flex shadow-inner relative">
                                    <div className={`h-full rounded-full transition-all duration-500 shadow-[0_0_10px_currentColor] ${
                                        masterBrandFilter === 'Dermes' ? 'bg-orange-500' :
                                        masterBrandFilter === 'Reenex' ? 'bg-red-600' :
                                        masterBrandFilter === 'Elyze' ? 'bg-green-500' : 'bg-slate-500'
                                    }`} style={{ width: '100%' }}></div>
                                </div>
                                {masterBrandFilter === "ALL" && (
                                    <div className="grid grid-cols-3 gap-2 relative z-10">
                                        {BRANDS.map(b => {
                                            const val = racers.filter(r => r.brand === b).reduce((a, sum) => a + sum.sales, 0);
                                            let colors = { bg: 'bg-slate-700', text: 'text-slate-400', border: 'border-slate-600' };
                                            if (b === 'Dermes') colors = { bg: 'bg-orange-900/30', text: 'text-orange-400', border: 'border-orange-500/30' };
                                            if (b === 'Reenex') colors = { bg: 'bg-red-900/30', text: 'text-red-400', border: 'border-red-500/30' };
                                            if (b === 'Elyze') colors = { bg: 'bg-green-900/30', text: 'text-green-400', border: 'border-green-500/30' };
                                            return (
                                                <div key={b} className={`${colors.bg} rounded-xl p-2 text-center border ${colors.border} hover:border-opacity-100 transition-all`}>
                                                    <div className={`text-[10px] ${colors.text} font-bold uppercase tracking-wide opacity-80`}>{b}</div>
                                                    <div className={`font-numbers font-bold ${colors.text} text-2xl leading-none mt-0.5`}>{val.toFixed(1)}</div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                             </F1Card>
                             <F1Card theme={theme} className="p-6 flex flex-col justify-between h-full bg-slate-800">
                                <div className="flex justify-between items-start">
                                    <h3 className={`text-slate-400 text-sm font-bold tracking-widest uppercase`}>ÈÅ∏ÊâãÊï∏Èáè</h3>
                                    <div className="bg-slate-700/50 p-3 rounded-full text-neon-purple border border-slate-600"><Store className="animate-pulse" size={32} /></div>
                                </div>
                                <div className="flex items-end justify-between"><div className={`text-7xl font-numbers font-bold text-white`}>{activeRacersCount} <span className="text-3xl text-slate-500">/ {filteredRacers.length}</span></div><div className={`text-xs font-bold text-neon-purple bg-purple-900/30 border border-purple-500/30 px-3 py-1 rounded-full uppercase tracking-wider`}>ACTIVE / TOTAL</div></div>
                             </F1Card>
                             <F1Card theme={theme} className={`p-6 flex flex-col justify-between h-full bg-gradient-to-br from-slate-800 to-slate-900 border border-slate-700 relative overflow-hidden`}>
                                <div className="absolute top-0 right-0 p-20 bg-neon-blue/10 rounded-full blur-3xl"></div>
                                <div className="flex justify-between items-start relative z-10">
                                    <h3 className={`text-neon-blue text-sm font-bold tracking-widest uppercase`}>ÁõÆÂâçÁ¨¨‰∏ÄÂêç</h3>
                                    <div className="bg-yellow-500/20 p-3 rounded-full text-yellow-400 border border-yellow-500/50 shadow-[0_0_15px_rgba(234,179,8,0.3)]"><Trophy className="animate-bounce" size={32} /></div>
                                </div>
                                <div className="relative z-10"><div className={`text-4xl font-bold text-white truncate mb-1`}>{top3[0]?.name || '-'}</div><div className={`text-neon-blue font-numbers text-5xl font-bold`}>{top3[0]?.sales.toFixed(1) || 0} <span className="text-xl text-slate-500">MILES</span></div></div>
                             </F1Card>
                        </div>
                    </section>

                    {/* --- LEADERBOARD SECTION --- */}
                    <section className="w-full">
                        <div className="flex flex-col md:flex-row md:items-center justify-between mb-4 gap-4">
                            <div className="flex items-center gap-4">
                                <h3 className={`text-3xl font-racing text-white italic tracking-wide flex items-center gap-3`}><span className="text-neon-purple"><Trophy size={32} /></span> ÂêÑÁ¥öÂØ¶ÂäõÈæçËôéÊ¶ú</h3>
                                <div className="flex bg-slate-800 p-1 rounded-full border border-slate-700">
                                    {[{ id: 'BRAND', label: 'ÂìÅÁâåÊ¶ú', icon: <Tag size={14} /> }, { id: 'HUB', label: 'ÂçÄÂüüÊ¶ú', icon: <MapPin size={14} /> }, { id: 'FLOOR', label: 'Ê®ìÂ±§Ê¶ú', icon: <Building size={14} /> }].map(tab => (
                                        <button key={tab.id} onClick={() => setLeaderboardView(tab.id)} className={`flex items-center gap-2 px-5 py-2 rounded-full text-xs font-bold uppercase tracking-wider transition-all ${leaderboardView === tab.id ? 'bg-neon-purple text-white shadow-[0_0_15px_rgba(188,19,254,0.4)]' : 'text-slate-400 hover:text-white hover:bg-slate-700'}`}>{tab.icon} {tab.label}</button>
                                    ))}
                                </div>
                            </div>
                            <div className="flex flex-wrap gap-2 items-center">
                                <div className="flex gap-1 bg-slate-800 p-1 rounded-full border border-slate-700">
                                    {['ALL', 'Dermes', 'Reenex', 'Elyze'].map(b => (
                                        <button key={b} onClick={() => setMasterBrandFilter(b)} className={`px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider transition-all ${masterBrandFilter === b ? (b === 'Dermes' ? 'bg-orange-500 shadow-[0_0_10px_rgba(249,115,22,0.4)]' : b === 'Reenex' ? 'bg-red-600 shadow-[0_0_10px_rgba(239,68,68,0.4)]' : 'bg-green-500 shadow-[0_0_10px_rgba(34,197,94,0.4)]') + ' text-white' : (b === 'ALL' && masterBrandFilter === 'ALL' ? 'bg-white text-slate-900 shadow-[0_0_10px_rgba(255,255,255,0.4)]' : 'text-slate-400 hover:text-white hover:bg-slate-700')}`}>{b === 'ALL' ? 'ALL' : b}</button>
                                    ))}
                                </div>
                                <div className="relative">
                                    <select value={lbNJFilter} onChange={(e) => setLbNJFilter(e.target.value)} className="appearance-none bg-slate-800 border border-slate-700 text-slate-300 py-2 pl-4 pr-10 rounded-full text-xs font-bold uppercase tracking-wider shadow-sm focus:outline-none focus:ring-2 focus:ring-neon-purple cursor-pointer hover:border-slate-500">
                                        <option value="ALL">ÊâÄÊúâ‰∫∫Âì°</option>
                                        <option value="Y">Êñ∞‰∫∫ (NJ)</option>
                                        <option value="N">ÈùûÊñ∞‰∫∫</option>
                                    </select>
                                    <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500 text-xs">‚ñº</div>
                                </div>
                                {/* NEW TIER FILTER DROPDOWN */}
                                <div className="relative">
                                    <select value={lbTierFilter} onChange={(e) => setLbTierFilter(e.target.value)} className="appearance-none bg-slate-800 border border-slate-700 text-slate-300 py-2 pl-4 pr-10 rounded-full text-xs font-bold uppercase tracking-wider shadow-sm focus:outline-none focus:ring-2 focus:ring-neon-purple cursor-pointer hover:border-slate-500">
                                        <option value="ALL">ÊâÄÊúâÁ≠âÁ¥ö</option>
                                        {TRACK_TIERS.map(t => <option key={t} value={t}>{t}</option>)}
                                    </select>
                                    <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-500 text-xs">‚ñº</div>
                                </div>
                            </div>
                        </div>
                        <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 animate-fade-in">
                            {leaderboardView === 'BRAND' && brandStats.map((item, idx) => renderLeaderboardCard(item, idx, 'BRAND'))}
                            {leaderboardView === 'HUB' && hubStats.map((item, idx) => renderLeaderboardCard(item, idx, 'HUB'))}
                            {leaderboardView === 'FLOOR' && floorStats.map((item, idx) => renderLeaderboardCard(item, idx, 'FLOOR'))}
                        </div>
                    </section>
                    
                    {/* TRACK SECTION */}
                    <section>
                         <div className="bg-slate-800 rounded-2xl shadow-md p-4 mb-4 border border-slate-700">
                             <div className="flex flex-col md:flex-row justify-between items-center gap-4">
                                 <div className="flex items-center gap-2 flex-wrap">
                                     <span className="text-slate-400 text-xs font-bold uppercase tracking-wider">Ë∫´‰ªΩÁØ©ÈÅ∏:</span>
                                     <MultiSelectDropdown 
                                        label="ÂìÅÁâå" 
                                        options={BRANDS} 
                                        selected={trackFilterBrand} 
                                        onChange={setTrackFilterBrand} 
                                        theme={theme}
                                     />
                                     <MultiSelectDropdown 
                                        label="ÂçÄÂüü" 
                                        options={uniqueTrackHubs} 
                                        selected={trackFilterHub} 
                                        onChange={setTrackFilterHub} 
                                        theme={theme}
                                     />
                                     <MultiSelectDropdown 
                                        label="Ê®ìÂ±§" 
                                        options={uniqueTrackFloors} 
                                        selected={trackFilterFloor} 
                                        onChange={setTrackFilterFloor} 
                                        theme={theme}
                                     />
                                 </div>
                                 
                                 <div className="flex items-center gap-2">
                                     <span className="text-slate-400 text-xs font-bold uppercase tracking-wider">Ë∑ëÈÅìÁ≠âÁ¥ö:</span>
                                     <MultiSelectDropdown 
                                        label="Á≠âÁ¥ö" 
                                        options={TRACK_TIERS} 
                                        selected={trackFilterTier} 
                                        onChange={setTrackFilterTier} 
                                        theme={theme}
                                     />
                                 </div>
                                 <div className="flex items-center gap-2">
                                     <span className="text-slate-400 text-xs font-bold uppercase tracking-wider">ÈáåÊï∏:</span>
                                     <MultiSelectDropdown 
                                        label="ÈáåÊï∏" 
                                        options={MILES_RANGES} 
                                        selected={trackFilterMiles} 
                                        onChange={setTrackFilterMiles} 
                                        theme={theme}
                                     />
                                 </div>
                             </div>
                         </div>
                        <ImpactfulStraightTrack data={trackRacers} title="ÊéíË°åÊ¶úÊøÄÊà∞" theme={theme} height="1500px" />
                    </section>
                    
                    <section className="grid grid-cols-1 gap-6">
                        <div className="relative">
                             <div className="text-center mb-6"><h3 className={`text-3xl md:text-5xl font-racing font-bold text-white flex items-center justify-center gap-3 drop-shadow-md`}><span className="text-neon-green"><Info size={32} /></span> Âä†ÈÄüÊîªÁï•</h3><p className={`text-slate-400 mt-2 text-sm uppercase tracking-widest`}>ÊéåÊè°‰ª•‰∏ã‰∫îÂ§ßÊ≥ïÂâáÔºåÂä©ÂäõËÇ•ÁâõÈ£õÈÄüË°ùÂà∫ÔºÅüöÄ</p></div>
                             <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-3">
                                <F1Card theme={theme} className="p-3 bg-slate-800/80 border border-slate-700 hover:border-neon-green/50 hover:shadow-[0_0_20px_rgba(10,255,104,0.1)] transition-all flex flex-col justify-between h-full"><div className="flex items-center gap-2 mb-2"><div className="w-8 h-8 bg-green-900/30 text-neon-green rounded-full flex items-center justify-center font-bold text-sm border border-green-500/30">1</div><h4 className={`text-xs font-bold text-white uppercase tracking-wider`}>PN+ Paid Trial</h4></div><div className="bg-slate-900/50 p-2 rounded-lg mb-2 text-center border border-slate-700 grow flex items-center justify-center"><p className={`text-[10px] text-slate-400`}>ÊØèË≥£Âá∫ <strong className="text-neon-green">1 ÂÄã</strong></p></div><div className="bg-green-900/40 text-neon-green border border-green-500/30 text-center py-1 rounded-full font-bold text-[10px] uppercase tracking-widest">+ 2 Ëã±Èáå üÜï</div></F1Card>
                                <F1Card theme={theme} className="p-3 bg-slate-800/80 border border-slate-700 hover:border-neon-blue/50 hover:shadow-[0_0_20px_rgba(0,243,255,0.1)] transition-all flex flex-col justify-between h-full"><div className="flex items-center gap-2 mb-2"><div className="w-8 h-8 bg-cyan-900/30 text-neon-blue rounded-full flex items-center justify-center font-bold text-sm border border-cyan-500/30">2</div><h4 className={`text-xs font-bold text-white uppercase tracking-wider`}>PN+ Package</h4></div><div className="bg-slate-900/50 p-2 rounded-lg mb-2 text-center border border-slate-700 grow flex items-center justify-center"><p className={`text-[10px] text-slate-400`}>ÊØè <strong className="text-neon-blue">$10,000</strong></p></div><div className="bg-cyan-900/40 text-neon-blue border border-cyan-500/30 text-center py-1 rounded-full font-bold text-[10px] uppercase tracking-widest">+ 2 Ëã±Èáå ‚ö°</div></F1Card>
                                <F1Card theme={theme} className="p-3 bg-slate-800/80 border border-slate-700 hover:border-blue-500/50 hover:shadow-[0_0_20px_rgba(59,130,246,0.1)] transition-all flex flex-col justify-between h-full"><div className="flex items-center gap-2 mb-2"><div className="w-8 h-8 bg-blue-900/30 text-blue-400 rounded-full flex items-center justify-center font-bold text-sm border border-blue-500/30">3</div><h4 className={`text-xs font-bold text-white uppercase tracking-wider`}>PN+ Combo</h4></div><div className="bg-slate-900/50 p-2 rounded-lg mb-2 text-center border border-slate-700 grow flex items-center justify-center"><p className={`text-[10px] text-slate-400`}>PN+ & PLLA5 <strong className="text-blue-400">Sys</strong></p></div><div className="bg-blue-900/40 text-blue-400 border border-blue-500/30 text-center py-1 rounded-full font-bold text-[10px] uppercase tracking-widest">+ 4 Ëã±Èáå üöÄ</div></F1Card>
                                <F1Card theme={theme} className="p-3 bg-slate-800/80 border border-slate-700 hover:border-neon-purple/50 hover:shadow-[0_0_20px_rgba(188,19,254,0.1)] transition-all flex flex-col justify-between h-full"><div className="flex items-center gap-2 mb-2"><div className="w-8 h-8 bg-purple-900/30 text-neon-purple rounded-full flex items-center justify-center font-bold text-sm border border-purple-500/30">4</div><h4 className={`text-xs font-bold text-white uppercase tracking-wider`}>Plla 5 Product</h4></div><div className="bg-slate-900/50 p-2 rounded-lg mb-2 text-center border border-slate-700 grow flex items-center justify-center"><p className={`text-[10px] text-slate-400`}>ÊØèË≥£Âá∫ <strong className="text-neon-purple">2 ÂÄã</strong> <span className="block scale-75 opacity-50">(ÊäòÂæå$592)</span></p></div><div className="bg-purple-900/40 text-neon-purple border border-purple-500/30 text-center py-1 rounded-full font-bold text-[10px] uppercase tracking-widest">+ 2 Ëã±Èáå ‚ú®</div></F1Card>
                                <F1Card theme={theme} className="p-3 bg-slate-800/80 border border-slate-700 hover:border-orange-500/50 hover:shadow-[0_0_20px_rgba(249,115,22,0.1)] transition-all flex flex-col justify-between h-full"><div className="flex items-center gap-2 mb-2"><div className="w-8 h-8 bg-orange-900/30 text-orange-400 rounded-full flex items-center justify-center font-bold text-sm border border-orange-500/30">5</div><h4 className={`text-xs font-bold text-white uppercase tracking-wider`}>Plla 5 X Ultrajet</h4></div><div className="bg-slate-900/50 p-2 rounded-lg mb-2 text-center border border-slate-700 grow flex items-center justify-center"><p className={`text-[10px] text-slate-400`}>ÊØèË≥£Âá∫ <strong className="text-orange-400">1 Â•ó</strong></p></div><div className="bg-orange-900/40 text-orange-400 border border-orange-500/30 text-center py-1 rounded-full font-bold text-[10px] uppercase tracking-widest">+ 3 Ëã±Èáå üî•</div></F1Card>
                                <F1Card theme={theme} className="p-3 bg-slate-800/80 border border-slate-700 hover:border-red-500/50 hover:shadow-[0_0_20px_rgba(239,68,68,0.1)] transition-all flex flex-col justify-between border-2 border-red-200 relative overflow-hidden"><div className="absolute top-0 right-0 bg-red-500 text-white text-[9px] font-bold px-2 py-0.5 rounded-bl-lg z-10">FEB NEW</div><div className="flex items-center gap-2 mb-2"><div className="w-8 h-8 bg-red-900/30 text-red-400 rounded-full flex items-center justify-center font-bold text-sm border border-red-500/30"><RefreshCw size={14}/></div><h4 className={`text-sm font-bold ${theme.textMain} leading-tight`}>Áî¢ÂìÅË®ÇÈñ±</h4></div><div className="bg-slate-900/50 p-2 rounded-lg mb-2 text-center border border-slate-700 grow flex items-center justify-center"><p className={`text-[10px] text-slate-400`}>ÊØèË≥£Âá∫ <strong className="text-red-400">1 ÂÄã</strong></p></div><div className="bg-red-900/40 text-red-400 border border-red-500/30 text-center py-1 rounded-full font-bold text-[10px] uppercase tracking-widest">+ 2 Ëã±Èáå ‚ù§Ô∏è</div></F1Card>
                             </div>

                             {/* Track Levels Legend */}
                             <F1Card theme={theme} className="mt-4 p-6 bg-slate-800/80 border border-slate-700 relative overflow-hidden backdrop-blur-sm">
                                <div className="flex flex-col gap-6 relative z-10">
                                    <div className="text-center">
                                        <h4 className={`text-2xl font-racing text-white italic tracking-wider flex items-center justify-center gap-2 mb-2`}>
                                            <span className="text-3xl text-yellow-400">üèÜ</span> ÂâµÊÑèË∑ëÈÅìÊôâÂçáÈöéÊ¢Ø
                                        </h4>
                                        <span className={`text-xs font-bold bg-slate-700/50 px-4 py-1.5 rounded-full border border-slate-600 text-slate-400 inline-block uppercase tracking-widest`}>Êåâ‰∫åÊúàÂÄã‰∫∫Èä∑ÂîÆÁõÆÊ®ôÈÅîÊàêÁéá (%) Ëß£ÈéñÂ∞àÂ±¨Ë∑ëÈÅì</span>
                                    </div>
                                    <div className="grid grid-cols-2 sm:grid-cols-4 lg:grid-cols-8 gap-4 px-2">
                                        {[
                                            { pct: "<100%", name: "Âü∫Êú¨", icon: "üå±", bg: "bg-slate-800", border: "border-slate-600", text: "text-slate-500" },
                                            { pct: "100%", name: "ÂÖ•ÈñÄ", icon: "‚úÖ", bg: "bg-green-900/20", border: "border-green-600", text: "text-green-400" },
                                            { pct: "110%", name: "ÂÖàÈãí", icon: "üõ°Ô∏è", bg: "bg-blue-900/20", border: "border-blue-600", text: "text-blue-400" },
                                            { pct: "120%", name: "Â§©Êâç", icon: "üß†", bg: "bg-purple-900/20", border: "border-purple-600", text: "text-purple-400" },
                                            { pct: "130%", name: "Ë∂ÖÁ¥ö", icon: "üöÄ", bg: "bg-orange-900/20", border: "border-orange-600", text: "text-orange-400" },
                                            { pct: "140%", name: "Ê•µÈôê", icon: "üî•", bg: "bg-red-900/20", border: "border-red-600", text: "text-red-400" },
                                            { pct: "150%", name: "ÂÇ≥Â•á", icon: "ü¶Ñ", bg: "bg-yellow-900/20", border: "border-yellow-600", text: "text-yellow-400" },
                                            { pct: "160%", name: "Ëàâ‰∏ñÁÑ°Èõô", icon: "üëë", bg: "bg-slate-900", border: "border-white", text: "text-rainbow", special: true },
                                        ].map((level, idx) => (
                                            <div key={level.name} className={`relative group ${level.bg} p-3 rounded-xl text-center border-b-2 ${level.border} hover:border-b-4 hover:-translate-y-1 transition-all duration-300 cursor-default flex flex-col items-center justify-between h-full`}>
                                                <div className={`absolute -top-3 -right-2 w-5 h-5 bg-slate-900 text-white rounded-full flex items-center justify-center text-[9px] font-black border-2 border-white shadow-md z-20`}>{idx + 1}</div>
                                                <div className="text-2xl mb-2 group-hover:scale-110 transition-transform">{level.icon}</div>
                                                <div className={`font-bold text-xs mb-2 ${level.text}`}>{level.name}</div>
                                                <div className={`text-[9px] font-bold bg-slate-900/50 text-slate-400 rounded-full py-1 px-2 border border-slate-700 w-full`}>{level.pct}</div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                             </F1Card>
                        </div>
                    </section>

                    {/* --- REWARDS SECTION (NEW) --- */}
                    <section className="grid grid-cols-1 gap-6">
                        <div className="relative">
                             <div className="text-center mb-6"><h3 className={`text-2xl md:text-3xl font-cute ${theme.textMain} font-bold flex items-center justify-center gap-3`}><span className="bg-yellow-500/20 p-1.5 rounded-full text-yellow-400 border border-yellow-500/50"><Gift size={24} /></span> ÈáåÊï∏ÁçéË≥û</h3><p className={`${theme.textSub} font-cute text-base mt-1`}>Á¥ØÁ©çÈáåÊï∏ÔºåÊèõÂèñË±êÂØåÁçéÂìÅÔºÅ</p></div>
                             <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                                {REWARDS.map((reward, idx) => (
                                    <F1Card key={idx} theme={theme} className={`p-4 bg-slate-800/80 border border-slate-700 hover:border-${reward.color}-500/50 hover:shadow-[0_0_20px_rgba(255,255,255,0.05)] transition-all h-full flex flex-col relative overflow-hidden group`}>
                                        <div className={`absolute -right-10 -top-10 w-24 h-24 bg-${reward.color}-500/10 rounded-full blur-xl group-hover:bg-${reward.color}-500/20 transition-colors`}></div>
                                        <div className="flex justify-between items-start mb-3 relative z-10">
                                            <span className={`text-3xl filter drop-shadow-md`}>{reward.icon}</span>
                                            <span className={`px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider border bg-${reward.color}-900/30 text-${reward.color}-400 border-${reward.color}-500/30`}>{reward.title}</span>
                                        </div>
                                        <p className={`text-sm font-bold text-slate-300 leading-snug relative z-10 group-hover:text-white transition-colors`}>{reward.reward}</p>
                                    </F1Card>
                                ))}
                             </div>
                        </div>
                    </section>

                    {/* --- SECTION 5: DRIVER LICENSE (SCORECARD) --- */}
                    <section className="pt-12 border-t border-dashed border-slate-700">
                        <div className="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                            <div><h2 className={`text-3xl md:text-4xl font-racing text-white italic tracking-wide flex items-center gap-3`}><span className="text-neon-blue"><Target size={32} /></span> ÂÄã‰∫∫ÊàêÁ∏æÂñÆ</h2><p className={`text-slate-400 mt-2 text-sm tracking-widest uppercase`}>Êü•ÁúãÂÄãÂà•ÂèÉË≥ΩËÄÖÁöÑË©≥Á¥∞ÂæóÂàÜËàá‰ªªÂãôÈÅîÊàêÁãÄÊ≥Å</p></div>
                            <div className={`flex flex-col sm:flex-row gap-3 items-stretch sm:items-center bg-slate-800 p-3 rounded-2xl border border-slate-700 shadow-lg w-full md:w-auto`}>
                                <div className="relative flex-1"><select value={scBrand} onChange={(e) => { setScBrand(e.target.value); setScHub('ALL'); setScFloor('ALL'); }} className="w-full bg-slate-700 text-slate-200 text-sm rounded-xl pl-4 pr-10 py-3 focus:ring-2 focus:ring-neon-blue outline-none border border-slate-600 font-bold uppercase cursor-pointer hover:bg-slate-600 transition-colors appearance-none"><option value="ALL">ÊâÄÊúâÂìÅÁâå</option>{BRANDS.map(b => <option key={b} value={b}>{b}</option>)}</select><div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">‚ñº</div></div>
                                <div className="relative flex-1"><select value={scHub} onChange={(e) => { setScHub(e.target.value); setScFloor('ALL'); }} className="w-full bg-slate-700 text-slate-200 text-sm rounded-xl pl-4 pr-10 py-3 focus:ring-2 focus:ring-neon-blue outline-none border border-slate-600 font-bold uppercase cursor-pointer hover:bg-slate-600 transition-colors appearance-none"><option value="ALL">ÊâÄÊúâHub</option>{uniqueHubs.map(h => <option key={h} value={h}>{h}</option>)}</select><div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">‚ñº</div></div>
                                <div className="relative flex-1"><select value={scFloor} onChange={(e) => setScFloor(e.target.value)} className="w-full bg-slate-700 text-slate-200 text-sm rounded-xl pl-4 pr-10 py-3 focus:ring-2 focus:ring-neon-blue outline-none border border-slate-600 font-bold uppercase cursor-pointer hover:bg-slate-600 transition-colors appearance-none"><option value="ALL">ÊâÄÊúâÊ®ìÂ±§</option>{uniqueFloors.map(s => <option key={s} value={s}>{s}</option>)}</select><div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">‚ñº</div></div>
                                <div className="relative flex-1"><select value={scRacerId} onChange={(e) => setScRacerId(e.target.value)} className="w-full bg-neon-blue text-slate-900 text-sm rounded-xl pl-4 pr-10 py-3 focus:ring-2 focus:ring-white outline-none border-none font-bold uppercase min-w-[150px] cursor-pointer hover:bg-cyan-400 transition-colors appearance-none shadow-md shadow-cyan-500/20">{scAvailableRacers.map(r => <option key={r.id} value={r.id}>{r.name}</option>)}</select><div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-slate-800">‚ñº</div></div>
                            </div>
                        </div>
                        {scRacerId && (() => {
                            const racer = racers.find(r => r.id.toString() === scRacerId);
                            const actualRank = sortedGlobal.findIndex(r => r.id.toString() === scRacerId) + 1;
                            const breakdown = getRacerBreakdown(racer);
                            const trackLevel = getTrackLevel(breakdown.achievement_pct);
                            if (!racer) return null;
                            return (
                                <div className="bg-slate-800 rounded-[2rem] shadow-2xl overflow-hidden relative border border-slate-700 text-slate-200 transform hover:scale-[1.005] transition-transform duration-500">
                                    <div className="absolute top-0 right-0 p-40 bg-neon-blue/5 rounded-full blur-[100px] pointer-events-none"></div>
                                    <div className="grid grid-cols-1 lg:grid-cols-3 relative z-10">
                                        <div className="p-10 bg-slate-900/50 flex flex-col items-center justify-center border-b lg:border-b-0 lg:border-r border-slate-700 relative">
                                            <div className="w-40 h-40 rounded-full bg-slate-800 p-2 mb-6 relative shadow-2xl border-4 border-slate-700 group"><img src={getBrandGif(racer.brand)} className="w-full h-full object-contain rounded-full bg-slate-900" /><div className="absolute -bottom-2 -right-2 bg-yellow-500 text-yellow-900 w-12 h-12 flex items-center justify-center font-black rounded-full border-4 border-slate-800 text-2xl font-racing shadow-lg group-hover:scale-110 transition-transform">#{actualRank}</div></div>
                                            <h2 className="text-3xl font-bold text-center mb-3 text-white tracking-wide">{racer.name}</h2>
                                            <div className="flex gap-2 mb-6"><span className="px-3 py-1 bg-slate-800 border border-slate-600 rounded-full text-xs text-slate-400 font-bold uppercase tracking-wider">{racer.brand}</span><span className="px-3 py-1 bg-slate-800 border border-slate-600 rounded-full text-xs text-slate-400 font-bold uppercase tracking-wider">{racer.hub}</span><span className="px-3 py-1 bg-slate-800 border border-slate-600 rounded-full text-xs text-slate-400 font-bold uppercase tracking-wider">{racer.floor}</span></div>
                                            
                                            {/* Achievement Bar */}
                                            <div className="w-full px-6 mb-8">
                                                <div className="flex justify-between text-xs font-bold text-slate-400 mb-2 uppercase tracking-wider"><span>Èä∑ÂîÆÈÅîÊàêÁéá</span><div className="text-right"><span className="block text-lg text-white font-numbers">{breakdown.achievement_pct.toFixed(0)}%</span><span className="text-[10px] opacity-60">{formatCurrency(breakdown.actual).replace('HK$', '$')} / {formatCurrency(breakdown.target).replace('HK$', '$')}</span></div></div>
                                                <div className="w-full bg-slate-700 h-3 rounded-full overflow-hidden border border-slate-600"><div className={`h-full ${trackLevel.bg.replace('bg-', 'bg-')}`} style={{ width: `${Math.min(breakdown.achievement_pct, 100)}%`, background: 'linear-gradient(90deg, #00f3ff, #bc13fe)' }}></div></div>
                                                <div className={`text-center mt-3 font-bold ${trackLevel.color} text-sm uppercase tracking-widest`}>{trackLevel.icon} {trackLevel.name}ÂâµÊÑèË∑ëÈÅì</div>
                                            </div>

                                            <div className="text-center bg-slate-800 p-6 rounded-2xl border border-slate-700 w-full"><div className="text-xs text-slate-500 uppercase tracking-[0.2em] mb-1 font-bold">Á∏ΩÈáåÁ®ã (Total)</div><div className="text-6xl font-numbers font-bold text-neon-blue leading-none text-shadow-neon">{racer.sales.toFixed(1)}</div><div className="text-slate-500 text-xs font-bold mt-1 tracking-widest">MILES</div></div>
                                        </div>
                                        <div className="lg:col-span-2 p-10 bg-slate-800">
                                            <h4 className="text-slate-400 font-bold uppercase text-xs mb-8 flex items-center tracking-[0.2em] border-b border-slate-700 pb-4"><Zap size={16} className="mr-2 text-yellow-500" /> Ë°®ÁèæË©≥Á¥∞ÂàÜÊûê</h4>
                                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-6">
                                                {[{ label: "PN+ Paid Trial", count: breakdown.pnPaidTrial, points: breakdown.pnPaidTrial * 2, color: "teal", icon: "üÜï" }, { label: "PN+ Package", count: breakdown.pnPackage, points: Math.floor(breakdown.pnPackage / 10000) * 2, color: "cyan", revenue: breakdown.pnPackage, icon: "‚ö°" }, { label: "PN+ Combo Sys", count: breakdown.combo, points: breakdown.combo * 4, color: "blue", icon: "üöÄ" }, { label: "Plla 5 Product", count: breakdown.plla, points: Math.floor(breakdown.plla / 2) * 2, color: "purple", icon: "‚ú®" }, { label: "Plla 5 X Ultrajet", count: breakdown.device, points: breakdown.device * 3, color: "orange", icon: "üî•" }, { label: "Áî¢ÂìÅË®ÇÈñ± (Feb)", count: breakdown.sub, points: breakdown.sub * 2, color: "red", icon: "‚ù§Ô∏è" }].map((item, idx) => (
                                                    <div key={idx} className={`bg-slate-700/50 rounded-xl p-5 border border-slate-600 hover:border-slate-500 transition-colors`}>
                                                        <div className="flex justify-between items-center mb-3"><span className={`text-slate-300 text-xs font-bold uppercase flex items-center tracking-wide`}><span className="mr-2 text-lg">{item.icon}</span> {item.label}</span><span className={`bg-slate-600 text-white font-numbers text-xl font-bold px-3 py-0.5 rounded shadow-sm border border-slate-500`}>+{item.points} M</span></div>
                                                        <div className="w-full bg-slate-900 h-2 rounded-full overflow-hidden border border-slate-700"><div className={`h-full rounded-full bg-${item.color}-500 shadow-[0_0_8px_currentColor]`} style={{ width: `${Math.min((item.revenue ? item.points : item.count) * 10, 100)}%` }}></div></div>
                                                        <div className="text-right text-xs text-slate-500 mt-2 font-bold uppercase tracking-wider">{item.label === "PN+ Package" ? `AMT: ${formatCurrency(item.revenue)}` : `QTY: ${item.count}`}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            );
                        })()}
                    </section>
                </main>
                <div className="fixed bottom-4 left-4 z-50 text-[10px] text-slate-500 bg-white/90 px-3 py-2 rounded-full shadow-lg border border-slate-200 backdrop-blur-sm pointer-events-none flex items-center gap-2">
                     {lastUpdated && !fetchError ? (<span className="flex items-center text-green-600 font-bold"><span className="w-2 h-2 rounded-full bg-green-500 mr-2 animate-pulse"></span>Â∑≤ÈÄ£Êé• (Update: {lastUpdated.toLocaleTimeString()})</span>) : (<span className="flex items-center text-orange-500 font-bold"><span className="w-2 h-2 rounded-full bg-orange-500 mr-2"></span>{fetchError ? 'ÈÄ£Êé•Â§±Êïó: ÊºîÁ§∫Ê®°Âºè' : 'ÊºîÁ§∫Ê®°Âºè'}</span>)}
                </div>
                <div className="fixed bottom-6 right-6 flex flex-col gap-2 z-50">
                    <button onClick={fetchData} className={`p-4 bg-green-500 text-white rounded-full shadow-2xl hover:bg-green-600 hover:scale-110 transition-all group ${isLoading ? 'animate-spin' : ''}`} title="Á´ãÂç≥Âà∑Êñ∞Êï∏Êìö"><RefreshCw className="w-6 h-6" /></button>
                </div>
            </div>
            );
        }
        
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SalesDerbyBlue />);
    </script>
</body>
</html>
