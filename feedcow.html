<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–°æ˜¥è‚¥ç‰›é£¼é¤Šå¤§è³½ | Intelligence Dashboard</title>
    <!-- Frameworks -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F0F8FF; }
        .cow-image-container {
            width: 100%; aspect-ratio: 4 / 3; position: relative; overflow: hidden;
            border-radius: 0.5rem; background-color: #f3f4f6; border: 2px solid #fff; 
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }
        .cow-image-container img { width: 100%; height: 100%; object-fit: contain; }
        .fence-bg {
            background-color: #81C784;
            background-image: radial-gradient(#A5D6A7 15%, transparent 16%), radial-gradient(#A5D6A7 15%, transparent 16%);
            background-size: 20px 20px; background-position: 0 0, 10px 10px;
        }
        .rank-badge { display: flex; align-items: center; justify-content: center; font-weight: 900; box-shadow: 0 2px 4px rgba(0,0,0,0.3); z-index: 50; }
        .brand-badge { font-size: 0.65rem; padding: 1px 6px; border-radius: 9999px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; }
        
        /* å“ç‰Œæ¨£å¼ */
        .brand-Dermes, .brand-dermes { background-color: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .brand-Reenex, .brand-reenex { background-color: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }
        .brand-Elyze, .brand-elyze { background-color: #fdf4ff; color: #a21caf; border: 1px solid #f5d0fe; }
        
        .tab-active-Dermes { background-color: #0369a1 !important; color: white !important; border-color: #0369a1 !important; }
        .tab-active-Reenex { background-color: #15803d !important; color: white !important; border-color: #15803d !important; }
        .tab-active-Elyze { background-color: #a21caf !important; color: white !important; border-color: #a21caf !important; }
        .view-active { background-color: #4b5563 !important; color: white !important; }

        .strength-bar { 
            position: absolute; left: 0; top: 0; height: 100%; opacity: 0.12; 
            transition: width 1.2s cubic-bezier(0.34, 1.56, 0.64, 1); z-index: 0; 
        }
        
        @keyframes modalFadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .animate-modal { animation: modalFadeIn 0.2s ease-out forwards; }
    </style>
</head>
<body class="pb-6 overflow-x-hidden text-gray-800">

    <script>
        // --- æ ¸å¿ƒé…ç½® ---
        window.GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwFLJr6n8QGwaDb-hBjC6xOwd2ANzDyW1b-iInQfQkxZEDDmP1U6F5lJampP6JNWjR6/exec'; 
        window.currentLang = 'zh';
        window.currentRankBrand = 'Dermes';
        window.currentNJFilter = 'all'; 
        window.currentViewLevel = 'floor'; 
        window.USERS = [];

        window.i18n = {
            zh: {
                utilizeAi: "åˆ©ç”¨ AI å°åº—", make: "ä»¤", cust: "å®¢äºº", bannerSlogan: "åšä»»å‹™è´å–é£¼æ–™ å„²ç³§é¤Šè‚¥ç‰›",
                leaderboardTitle: "è‚¥ç‰›æ’è¡Œæ¦œ", loading: "æ­£åœ¨è®€å–æ•¸æ“š...", tierTitle: "ç­‰ç´šèˆ‡çé …",
                feedGuideTitle: "é£¼æ–™ç²å–æ”»ç•¥", startWeightLabel: "èµ·å§‹é«”é‡", ratioLabel: "æˆé•·æ›ç®—",
                searchTitle: "æœå°‹æˆ‘çš„ç‰›ç‰›", allBrands: "æ‰€æœ‰å“ç‰Œ", allLocations: "æ‰€æœ‰æ¨“å±¤",
                cardWeightLabel: "ç›®å‰é«”é‡", cardFeedLabel: "ç´¯ç©é£¼æ–™", unlockedTitle: "ç›®å‰å¯ç²çå‹µ",
                task1: "æ–°å¢ 5 å€‹å°åº—è¿½è¹¤è€…", task2: "æ–°å¢ä¸€å€‹ACBæˆç‚ºåº—ä¸»", task3: "å®¢äººç”±å°åº—æ¶å¾—åˆ©æ˜¯ (æœ€å¤š25æ¬¡)", 
                task4: "æˆåŠŸé©…å‹•ACBé‚€è«‹å¥½å‹åƒèˆ‡æ´»å‹•ä¸¦ç²è´ˆ$1,888ç¦®åˆ¸",
                tLabel1: "è¿½è¹¤", tLabel2: "ACBåº—ä¸»", tLabel3: "æ¶åˆ©æ˜¯", tLabel4: "é©…å‹•ACB",
                goal: "ç›®æ¨™", maxLevel: "å·²é”æœ€é«˜ç´š", feedsToUpgrade: "å°šæ¬  {n} ä»½å‡ç´š", congrats: "é‡‘ç‰›é”æˆï¼",
                noMatch: "æ²’æœ‰çµæœ", floorRankTitle: "å¯¦åŠ›åˆ†ä½ˆçœ‹æ¿", avgWeight: "å¹³å‡é«”é‡",
                modalTitle: "ä»»å‹™èªªæ˜", modalClose: "æˆ‘çŸ¥é“äº†", btnExplain: "åœ–æ¨™èªªæ˜", distTitle: "åˆ†ä½ˆ",
                hcLabel: "HC",
                njAll: "å…¨éƒ¨äººå“¡", njNew: "æ–°äºº (NJ)", njSenior: "èˆŠäºº (Non-NJ)",
                viewBrand: "å“ç‰Œç´š", viewHub: "å€åŸŸç´š", viewFloor: "æ¨“å±¤ç´š",
                brandTotal: "å“ç‰Œç¸½è¨ˆ", hubTotal: "å€åŸŸç¸½è¨ˆ", floorDetail: "æ¨“å±¤è©³æƒ…",
                extraSogo: "åŠ è´ˆ SOGO ç¾é‡‘åˆ¸",
                tierRankLabel: "ç­‰ç´šå…§æ’å",
                bonusCond: "åŠé«”é‡é” {w}kg æˆ–ä»¥ä¸Š"
            },
            en: {
                utilizeAi: "Utilizing AI Shop", make: "Turning", cust: "Customers", bannerSlogan: "Complete Tasks to Grow",
                leaderboardTitle: "Fat Cow Leaderboard", loading: "Loading...", tierTitle: "Cow Evolution Tiers",
                feedGuideTitle: "Feed Acquisition Guide", startWeightLabel: "Start Weight", ratioLabel: "Ratio",
                searchTitle: "Search My Cow", allBrands: "All Brands", allLocations: "All Floors",
                cardWeightLabel: "Weight", cardFeedLabel: "Feeds", unlockedTitle: "Unlocked Reward",
                task1: "Add 5 shop followers", task2: "Add 1 ACB as owner", task3: "Red Packet from shop (Max 25)", 
                task4: "Drive ACB to refer friends for $1,888",
                tLabel1: "Follows", tLabel2: "ACB Owner", tLabel3: "Packets", tLabel4: "Drive ACB",
                goal: "Goal", maxLevel: "Max Level", feedsToUpgrade: "{n} feeds needed", congrats: "Golden Cow Raised!",
                noMatch: "No matches", floorRankTitle: "Intelligence Board", avgWeight: "Avg Weight",
                modalTitle: "Task Legend", modalClose: "Got it", btnExplain: "Legend", distTitle: "Dist",
                hcLabel: "HC",
                njAll: "All Staff", njNew: "New Joiner (NJ)", njSenior: "Senior (Non-NJ)",
                viewBrand: "Brand", viewHub: "Hub", viewFloor: "Floor",
                brandTotal: "Brand Total", hubTotal: "Hub Total", floorDetail: "Floor Detail",
                extraSogo: "Bonus SOGO Coupon",
                tierRankLabel: "Rank in Tier",
                bonusCond: "and weight reach {w}kg+"
            }
        };

        window.MILESTONES = [
            { min: 300, max: 499, title: {zh: "ç˜¦ç‰›", en: "Lean Cow"}, color: "text-gray-400", barColor: "bg-gray-400", img: "https://i.postimg.cc/pdy5zLJq/Whats-App-Image-2026-01-16-at-15-00-48.jpg", reward: { zh: "ç¹¼çºŒåŠªåŠ›ï¼åŠ æ²¹ï¼", en: "Keep trying!" } }, 
            { min: 500, max: 599, title: {zh: "ä¿¡æœ›æ„›æ¾³æ´²ç‰›", en: "FHL Australian Beef"}, color: "text-green-700", barColor: "bg-green-500", img: "https://i.postimg.cc/52sFXCLL/Whats-App-Image-2026-01-16-at-15-01-13.jpg", reward: { zh: "Bicelle 3D Mask X5", en: "Bicelle Mask X5" } }, 
            { min: 600, max: 699, title: {zh: "å…¬ç¾©ç¾åœ‹ç©€é£¼ç‰›", en: "Righteous US Beef"}, color: "text-blue-700", barColor: "bg-blue-500", img: "https://i.postimg.cc/9QLqD7ZP/Whats-App-Image-2026-01-16-at-15-00-50.jpg", reward: { zh: "Exuviance AP25ç…¥è†šçµ„åˆ", en: "Exuviance AP25 Kit" } }, 
            { min: 700, max: 799, title: {zh: "å¹³å®‰æ—¥æœ¬å’Œç‰›", en: "Peaceful Japanese Wagyu"}, color: "text-purple-700", barColor: "bg-purple-500", img: "https://i.postimg.cc/Bnm1jKH1/Whats-App-Image-2026-01-16-at-15-00-49.jpg", reward: { zh: "Celluion æ´»æ€§è† åŸçµ„åˆ", en: "Celluion Kit" } }, 
            { 
                min: 800, max: 1099, title: {zh: "å–œæ¨‚è±ç››é‡‘ç‰›", en: "Joyful Abundant Golden Cow"}, 
                color: "text-yellow-700 font-black", barColor: "bg-yellow-500", 
                img: "https://i.postimg.cc/2S0B1Zhv/Whats-App-Image-2026-01-16-at-15-00-49-(1).jpg", 
                reward: { zh: "Celluion è¶…è²æ³¢ PLLA å¥—è£", en: "Celluion PLLA Set" },
                bonusThreshold: 1000, bonusRank: 3, bonusValue: 300
            }, 
            { 
                min: 1100, max: 99999, title: {zh: "è¶…ç´šå‰µæ„å½©é‘½ç‰›", en: "Super Creative Diamond Cow"}, 
                color: "text-blue-500 font-black", barColor: "bg-blue-400", 
                img: "https://i.postimg.cc/fyF4pP8b/Whats-App-Image-2026-02-02-at-11-34-55.jpg", 
                reward: { zh: "Celluion è¶…è²æ³¢ PLLA å¥—è£", en: "Celluion PLLA Set" },
                bonusRank: 3, bonusValue: 500
            } 
        ];

        function getCowStatus(w) { return window.MILESTONES.find(m => w >= m.min && w <= m.max) || window.MILESTONES[0]; }
        function getNextMilestone(w) { return window.MILESTONES.find(m => m.min > w); }
        function calculateStats(t1, t2, t3, t4) {
            const cappedT3 = Math.min(25, t3);
            const totalFeeds = (t1 * 1) + (t2 * 2) + (cappedT3 * 2) + (t4 * 3);
            return { totalFeeds, weight: 300 + (totalFeeds * 5) };
        }
        function getProp(obj, names) { for (let name of names) { if (obj[name] !== undefined) return typeof obj[name] === 'string' ? obj[name].trim() : obj[name]; } return ""; }
        function toggleMissionModal(show) { const m = document.getElementById('mission-modal'); if(m) show ? m.classList.remove('hidden') : m.classList.add('hidden'); }
    </script>

    <!-- Language Switcher -->
    <div class="fixed top-4 right-4 z-[100] flex gap-1 bg-white/90 backdrop-blur-md p-1.5 rounded-full shadow-lg border border-gray-100">
        <button onclick="changeLanguage('zh')" id="btn-zh" class="px-4 py-1.5 rounded-full text-sm font-black transition-all bg-red-600 text-white shadow-md">ä¸­</button>
        <button onclick="changeLanguage('en')" id="btn-en" class="px-4 py-1.5 rounded-full text-sm font-black text-gray-500 hover:bg-gray-100">EN</button>
    </div>

    <!-- Header Area -->
    <div class="relative w-screen ml-[calc(-50vw+50%)]">
        <img src="https://i.postimg.cc/dVZ3Wyrh/Whats-App-Image-2026-01-16-at-13-05-41.jpg" alt="Poster" class="w-full h-auto block">
    </div>

    <!-- Banner -->
    <div class="relative w-screen ml-[calc(-50vw+50%)] shadow-2xl overflow-hidden bg-red-900 flex items-center justify-center py-6 border-b-4 border-yellow-500 text-center md:text-left">
        <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-br from-red-800 to-red-950 z-0 opacity-80"></div>
        <div class="relative z-10 w-full max-w-7xl px-4 sm:px-8 md:px-20 text-white flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex-1 space-y-1">
                <h2 class="text-4xl sm:text-5xl lg:text-7xl font-black leading-none tracking-tighter">
                    <span id="txt-make">ä»¤</span><span class="text-yellow-400">20,000</span><span id="txt-cust">å®¢äºº</span>
                </h2>
                <div class="mt-2 inline-block bg-white/10 border border-white/20 px-4 py-1.5 rounded-xl">
                    <p id="txt-banner-slogan" class="text-lg sm:text-xl font-black text-yellow-400">åšä»»å‹™è´å–é£¼æ–™ å„²ç³§é¤Šè‚¥ç‰›</p>
                </div>
            </div>
            <div id="txt-event-title" class="text-xs sm:text-sm font-black bg-yellow-500 text-red-900 px-4 py-1.5 mt-2 transform -skew-x-12 inline-block shadow-lg uppercase tracking-widest">å…¨æ°‘é¤Šç‰› â€¢ ç©å‡ºè±ç››</div>
        </div>
    </div>

    <!-- Ranking Section -->
    <section class="px-2 pb-12 relative z-0 fence-bg pt-12 shadow-inner text-center">
        <div class="w-full max-w-[98%] mx-auto relative z-10">
           <div class="flex flex-col items-center justify-center gap-4 mb-10">
                <div class="flex items-center gap-4 bg-white/25 backdrop-blur-md px-8 py-4 rounded-full border-2 border-white/60 shadow-2xl">
                    <i data-lucide="trophy" class="w-12 h-12 text-yellow-300"></i>
                    <h2 id="txt-leaderboard-title" class="font-black text-white text-3xl md:text-7xl tracking-tighter">è‚¥ç‰›æ’è¡Œæ¦œ</h2>
                </div>
                <div class="bg-red-600/90 text-white px-8 py-1.5 rounded-full text-lg md:text-3xl font-black animate-pulse shadow-xl">LIVE UPDATE</div>
           </div>
           <div id="loading-indicator" class="flex flex-col items-center justify-center py-16">
               <div class="w-16 h-16 border-8 border-yellow-400 border-t-transparent rounded-full animate-spin mb-6"></div>
               <p id="txt-loading" class="text-white text-2xl font-black animate-pulse tracking-widest">æ­£åœ¨è®€å–ç‰§å ´æ•¸æ“š...</p>
           </div>
           <div id="leaderboard-grid" class="grid grid-cols-2 md:grid-cols-3 gap-x-3 gap-y-10 px-1 lg:px-16"></div>
        </div>
    </section>

    <!-- Floor Dashboard -->
    <section class="px-2 py-16 relative z-10 bg-white border-t border-b border-gray-100 shadow-sm overflow-hidden text-center">
        <div class="max-w-4xl mx-auto">
            <h3 id="txt-floor-rank-title" class="text-4xl md:text-7xl font-black text-gray-800 mb-10 tracking-tight">å¯¦åŠ›åˆ†ä½ˆçœ‹æ¿</h3>
            
            <div class="flex justify-center p-1.5 bg-gray-100 rounded-[2.5rem] mb-6 shadow-inner max-w-sm mx-auto border border-gray-200">
                <button onclick="switchRankBrand('Dermes')" id="tab-Dermes" class="flex-1 py-3 px-2 rounded-[2rem] text-xs md:text-base font-black transition-all tab-active-Dermes shadow-md">Dermes</button>
                <button onclick="switchRankBrand('Reenex')" id="tab-Reenex" class="flex-1 py-3 px-2 rounded-[2rem] text-xs md:text-base font-black transition-all text-gray-500">Reenex</button>
                <button onclick="switchRankBrand('Elyze')" id="tab-Elyze" class="flex-1 py-3 px-2 rounded-[2rem] text-xs md:text-base font-black transition-all text-gray-500">Elyze</button>
            </div>

            <div class="flex justify-center p-1 bg-gray-200 rounded-xl mb-6 max-w-xs mx-auto border border-gray-300">
                <button onclick="switchViewLevel('brand')" id="view-brand" class="flex-1 py-2 px-1 rounded-lg text-[10px] font-black transition-all text-gray-500">å“ç‰Œç´š</button>
                <button onclick="switchViewLevel('hub')" id="view-hub" class="flex-1 py-2 px-1 rounded-lg text-[10px] font-black transition-all text-gray-500">å€åŸŸç´š</button>
                <button onclick="switchViewLevel('floor')" id="view-floor" class="flex-1 py-2 px-1 rounded-lg text-[10px] font-black transition-all view-active shadow-sm">æ¨“å±¤ç´š</button>
            </div>

            <div class="flex justify-center mb-10">
                <div class="inline-flex items-center bg-gray-50 p-1 px-4 rounded-full border border-gray-200 shadow-sm">
                    <select id="nj-rank-filter" onchange="switchNJFilter(this.value)" class="bg-transparent text-gray-700 text-[10px] font-black outline-none appearance-none cursor-pointer">
                        <option value="all" id="txt-njAll">å…¨éƒ¨äººå“¡</option>
                        <option value="Y" id="txt-njNew">æ–°äºº (NJ)</option>
                        <option value="N" id="txt-njSenior">èˆŠäºº (Non-NJ)</option>
                    </select>
                </div>
            </div>

            <div id="combined-floor-content" class="space-y-4 px-1 min-h-[400px]"></div>
        </div>
    </section>

    <!-- Search Tool -->
    <section class="px-4 py-16 bg-white border-t border-gray-100 text-center">
         <div class="max-w-md mx-auto">
             <h2 id="txt-search-title" class="font-black text-gray-800 text-2xl mb-8 flex items-center justify-center gap-3">æœå°‹æˆ‘çš„ç‰›ç‰›</h2>
             <div class="grid grid-cols-2 gap-3 mb-4">
                 <select id="brand-filter" class="block w-full px-4 py-3 border-2 border-gray-200 rounded-2xl text-base bg-gray-50 focus:border-red-500 font-black appearance-none"><option value="">æ‰€æœ‰å“ç‰Œ</option><option value="Dermes">Dermes</option><option value="Reenex">Reenex</option><option value="Elyze">Elyze</option></select>
                 <select id="location-filter" class="block w-full px-4 py-3 border-2 border-gray-200 rounded-2xl text-base bg-gray-50 focus:border-red-500 font-black appearance-none"><option value="">æ‰€æœ‰æ¨“å±¤</option></select>
             </div>
             <div class="relative mb-8"><select id="user-select" class="block w-full px-5 py-4 border-2 border-red-100 rounded-[1.5rem] bg-white focus:border-red-500 font-black shadow-lg appearance-none"></select></div>
             
             <!-- å€‹äººå¡ç‰‡ (ä¿®å¾© ID èˆ‡é¡¯ç¤ºé‚è¼¯) -->
             <div id="user-card" class="bg-[#FFF8E1] rounded-[2rem] p-5 border-4 border-[#8D6E63] hidden shadow-xl relative animate-modal text-left overflow-hidden">
                <div class="flex items-start gap-4 mb-4 relative z-10 text-left">
                    <div class="w-24 h-18 cow-image-container border-2 border-white shadow-md shrink-0"><img id="card-cow-img" src="" alt="Cow"></div>
                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start mb-1"><h3 id="card-name" class="text-2xl font-black text-[#3E2723] truncate tracking-tighter">å§“å</h3><span id="card-rank" class="bg-yellow-400 text-yellow-900 px-2 py-0.5 rounded-lg text-sm font-black shadow-md border-2 border-white"># -</span></div>
                        <div class="flex gap-1 mb-2"><span id="card-brand" class="brand-badge text-[8px]">BRAND</span><span id="card-location" class="bg-[#8D6E63] text-white px-2 py-0.5 rounded-full text-[8px] font-black uppercase shadow-sm">LOC</span></div>
                        <div class="flex items-baseline gap-2"><span id="card-weight" class="text-3xl font-black text-red-600 leading-none">0kg</span><span id="card-level-title" class="text-[10px] font-black text-[#8D6E63] uppercase truncate">ç­‰ç´š</span></div>
                    </div>
                </div>
                <div id="unlocked-reward-panel" class="bg-yellow-50/95 rounded-xl p-3 border-2 border-yellow-200 mb-4 flex items-center gap-3 shadow-inner">
                    <div class="w-8 h-8 bg-yellow-400 rounded-lg flex items-center justify-center shrink-0 shadow-sm"><i data-lucide="gift" class="w-4 h-4 text-white"></i></div>
                    <div class="flex-1 min-w-0">
                         <div id="card-reward-name" class="text-sm font-black text-gray-800 leading-tight">Reward Info</div>
                    </div>
                </div>
                <div class="bg-white rounded-xl p-3 border-2 border-[#FFE082] mb-4 shadow-sm relative text-center">
                    <div class="flex justify-between text-[10px] font-black text-[#5D4037] mb-1"><span>PROGRESS</span><span id="card-next-level" class="text-red-500 italic uppercase font-black">GOAL</span></div>
                    <div class="w-full bg-gray-100 rounded-full h-1.5 overflow-hidden"><div id="card-progress-bar" class="bg-green-500 h-full"></div></div>
                    <p id="card-diff-text" class="text-[9px] text-center text-gray-400 mt-1 font-bold italic">åŠªåŠ›ä¸­...</p>
                </div>
                <div class="border-t-2 border-[#D7CCC8] pt-4 border-dashed text-center"><div id="card-tasks-grid" class="grid grid-cols-2 gap-2 text-[10px]"></div></div>
             </div>
         </div>
    </section>

    <!-- Tiers & Guides -->
    <section class="px-3 py-16 relative z-10 bg-[#FFF3E0]">
        <div class="max-w-lg mx-auto">
             <div class="mb-10 shadow-xl rounded-3xl overflow-hidden border-4 border-[#8D6E63] bg-white relative">
                 <h4 class="font-black text-[#5D4037] text-xl p-4 bg-[#FFECB3] border-b-2 border-[#8D6E63] flex items-center justify-center gap-3 uppercase"><i data-lucide="award" class="w-6 h-6 text-yellow-700"></i> ç­‰ç´šèˆ‡çé …</h4>
                 <div id="tier-list-container" class="divide-y divide-gray-100 text-left"></div>
             </div>
        </div>
    </section>

    <footer class="text-center text-gray-400 text-xs py-10 font-bold opacity-60 uppercase tracking-widest">Â© 2026 Neoderm New Year Event</footer>

    <script>
        // --- æ ¸å¿ƒé‚è¼¯ ---
        function updateUI() {
            if (typeof i18n === 'undefined') return;
            const lang = window.i18n[window.currentLang];
            
            document.querySelectorAll("[id^='txt-']").forEach(el => {
                const key = el.id.replace('txt-', '');
                if (lang[key]) {
                    if (el.id === 'txt-floor-rank-title') el.innerHTML = `<i data-lucide="shield-check" class="w-8 h-8 md:w-16 md:h-16 text-blue-600"></i> ${lang[key]}`;
                    else el.textContent = lang[key];
                }
            });

            document.getElementById('txt-njAll').textContent = lang.njAll;
            document.getElementById('txt-njNew').textContent = lang.njNew;
            document.getElementById('txt-njSenior').textContent = lang.njSenior;
            document.getElementById('view-brand').textContent = lang.viewBrand;
            document.getElementById('view-hub').textContent = lang.viewHub;
            document.getElementById('view-floor').textContent = lang.viewFloor;

            // Condensed Tiers with Bonus Logic Text
            const tl = document.getElementById('tier-list-container');
            if(tl) {
                tl.innerHTML = [...window.MILESTONES].reverse().map(m => {
                    let bonusTxt = "";
                    if (m.bonusRank) {
                        const condition = m.bonusThreshold ? lang.bonusCond.replace('{w}', m.bonusThreshold) : "";
                        bonusTxt = `<div class="text-[9px] font-black text-red-600 mt-1 flex items-start gap-1"><i data-lucide="sparkles" class="w-2.5 h-2.5 shrink-0 mt-0.5"></i> <span>è‹¥é€²å…¥å‰ ${m.bonusRank} å ${condition}, åŠ è´ˆ SOGO $${m.bonusValue} ç¾é‡‘åˆ¸</span></div>`;
                    }
                    return `<div class="bg-white p-3 border-b border-gray-100 last:border-0 flex items-center gap-4 transition-all hover:bg-gray-50"><div class="w-12 h-10 rounded overflow-hidden shrink-0 bg-gray-50 border border-gray-100 shadow-sm flex items-center justify-center"><img src="${m.img}" class="w-full h-full object-contain ${m.min < 500 ? 'grayscale opacity-60' : ''}"></div><div class="flex-1 min-w-0 text-left"><div class="flex items-center justify-between"><span class="text-sm font-black text-gray-800 truncate">${m.title[window.currentLang]}</span><span class="text-[11px] font-black ${m.min >= 800 ? 'text-yellow-600' : 'text-gray-400'}">${m.min}kg+</span></div><div class="text-[10px] text-gray-600 italic leading-tight">${m.reward[window.currentLang]}</div>${bonusTxt}</div></div>`;
                }).join('');
            }

            populateFilterOptions();
            renderCombinedFloorDashboard();
            lucide.createIcons();
            renderLeaderboard();
            populateUserSelect();
        }

        function switchRankBrand(b) {
            window.currentRankBrand = b;
            ['Dermes', 'Reenex', 'Elyze'].forEach(tab => {
                const btn = document.getElementById(`tab-${tab}`);
                if(btn) btn.className = `flex-1 py-3 px-2 rounded-[2rem] text-xs md:text-base font-black transition-all ${tab === b ? `tab-active-${tab} shadow-xl` : 'text-gray-500'}`;
            });
            renderCombinedFloorDashboard();
        }

        function switchNJFilter(val) { window.currentNJFilter = val; renderCombinedFloorDashboard(); }

        function switchViewLevel(level) {
            window.currentViewLevel = level;
            ['brand', 'hub', 'floor'].forEach(l => {
                const btn = document.getElementById(`view-${l}`);
                if(btn) btn.className = `flex-1 py-2 px-1 rounded-lg text-[10px] font-black transition-all ${l === level ? 'view-active shadow-sm' : 'text-gray-500'}`;
            });
            renderCombinedFloorDashboard();
        }

        function renderCombinedFloorDashboard() {
            const container = document.getElementById('combined-floor-content');
            if(!container) return;
            const lang = i18n[window.currentLang];
            const brand = window.currentRankBrand;
            const prefix = brand === 'Dermes' ? 'D' : brand === 'Reenex' ? 'R' : 'E';
            const njFilter = window.currentNJFilter;
            const viewLevel = window.currentViewLevel;
            const hubsList = ['60/F', '32/F', 'TST', 'LP', 'PP', 'TS']; 
            
            let displayData = [];
            const filteredUsers = window.USERS.filter(u => {
                const bM = u.brand.toLowerCase().includes(brand.toLowerCase());
                const pM = u.location && u.location.toUpperCase().startsWith(prefix);
                const njM = (njFilter === 'all') || (u.nj === njFilter);
                return bM && pM && njM;
            });

            if (viewLevel === 'brand') {
                const total = filteredUsers.reduce((acc, u) => {
                    const s = getCowStatus(u.weight);
                    const mIdx = window.MILESTONES.findIndex(m => m.min === s.min);
                    acc.totalWeight += u.weight; acc.t1 += u.task1; acc.t2 += u.task2; acc.t3 += u.task3; acc.t4 += u.task4; acc.count += 1;
                    if(mIdx !== -1) acc.dist[mIdx]++;
                    return acc;
                }, { label: brand.toUpperCase(), totalWeight: 0, count: 0, t1: 0, t2: 0, t3: 0, t4: 0, dist: [0,0,0,0,0,0], isSummary: true, sub: lang.brandTotal });
                if(total.count > 0) displayData = [total];
            } 
            else if (viewLevel === 'hub') {
                const hubMap = hubsList.reduce((acc, h) => ({ ...acc, [h]: { label: h, totalWeight: 0, count: 0, t1: 0, t2: 0, t3: 0, t4: 0, dist: [0,0,0,0,0,0], isSummary: true, sub: lang.hubTotal }}), {});
                filteredUsers.forEach(u => {
                    const locUpper = u.location.toUpperCase();
                    let hubCode = null;
                    if (brand === 'Dermes') {
                        if (locUpper.includes("60")) hubCode = "60/F";
                        else if (locUpper.includes("32")) hubCode = "32/F";
                    }
                    if (!hubCode) {
                        if (locUpper.includes("PK RD") || locUpper.includes("TST")) hubCode = "TST";
                        else if (locUpper.includes("LP")) hubCode = "LP";
                        else if (locUpper.includes("PP")) hubCode = "PP";
                        else if (locUpper.includes("TS")) hubCode = "TS";
                    }
                    if(hubCode) {
                        const s = getCowStatus(u.weight);
                        const mIdx = window.MILESTONES.findIndex(m => m.min === s.min);
                        hubMap[hubCode].totalWeight += u.weight; hubMap[hubCode].count += 1;
                        hubMap[hubCode].t1 += u.task1; hubMap[hubCode].t2 += u.task2; hubMap[hubCode].t3 += u.task3; hubMap[hubCode].t4 += u.task4;
                        if(mIdx !== -1) hubMap[hubCode].dist[mIdx]++;
                    }
                });
                displayData = Object.values(hubMap).filter(h => h.count > 0).sort((a,b) => (b.totalWeight/b.count) - (a.totalWeight/a.count));
            } 
            else {
                const floorMap = {};
                filteredUsers.forEach(u => {
                    const loc = u.location;
                    if (!floorMap[loc]) floorMap[loc] = { label: loc, totalWeight: 0, count: 0, t1: 0, t2: 0, t3: 0, t4: 0, dist: [0,0,0,0,0,0], isSummary: false, sub: lang.floorDetail };
                    const s = getCowStatus(u.weight);
                    const mIdx = window.MILESTONES.findIndex(m => m.min === s.min);
                    floorMap[loc].totalWeight += u.weight; floorMap[loc].count += 1;
                    floorMap[loc].t1 += u.task1; floorMap[loc].t2 += u.task2; floorMap[loc].t3 += u.task3; floorMap[loc].t4 += u.task4;
                    if(mIdx !== -1) floorMap[loc].dist[mIdx]++;
                });
                displayData = Object.values(floorMap).sort((a,b) => (b.totalWeight/b.count) - (a.totalWeight/a.count));
            }

            const distColors = ['bg-gray-400', 'bg-green-500', 'bg-blue-500', 'bg-purple-500', 'bg-yellow-500', 'bg-blue-400'];
            const milestoneShortNames = ['ç˜¦ç‰›', 'æ¾³æ´²', 'ç¾åœ‹', 'å’Œç‰›', 'é‡‘ç‰›', 'å½©é‘½'];

            container.innerHTML = displayData.length > 0 ? displayData.map((f, idx) => {
                const avg = Math.round(f.totalWeight / f.count);
                const s = getCowStatus(avg);
                const next = getNextMilestone(avg);
                let prg = 100; if(next) prg = Math.min(100, Math.max(0, ((avg - s.min) / (next.min - s.min)) * 100));

                return `<div class="relative flex flex-col gap-4 p-5 pb-4 rounded-[2.5rem] bg-white border ${f.isSummary ? 'border-blue-200 shadow-lg' : 'border-gray-100'} shadow-xl overflow-hidden group text-left"><div class="strength-bar ${s.barColor}" style="width: ${prg}%"></div><div class="flex items-center gap-4 z-10 relative"><div class="flex flex-col items-center min-w-[45px] shrink-0 text-center">${f.isSummary ? `<div class="bg-blue-600 text-white p-2 rounded-full shadow-lg"><i data-lucide="${f.label.length > 5 ? 'award' : 'map-pin'}" class="w-4 h-4"></i></div>` : `<span class="w-10 h-10 flex items-center justify-center font-black rounded-full text-lg ${idx === 0 ? 'bg-yellow-400 text-white shadow-lg border-2 border-white' : 'bg-gray-100 text-gray-400'}">${idx + 1}</span>`}<span class="font-black text-gray-900 text-[11px] mt-1 uppercase tracking-tighter">${f.label}</span></div><div class="w-18 h-14 rounded-xl border-2 border-white overflow-hidden bg-white shrink-0 shadow-md flex items-center justify-center"><img src="${s.img}" class="w-full h-full object-contain"></div><div class="flex-1 min-w-0"><div class="text-[8px] font-black uppercase tracking-widest ${f.isSummary ? 'text-blue-600' : 'text-gray-400'}">${f.sub}</div><div class="text-[9px] font-black uppercase tracking-widest ${s.color}">${s.title[window.currentLang]}</div><div class="text-4xl font-black ${idx === 0 && !f.isSummary ? 'text-orange-600' : 'text-gray-800'} tracking-tighter leading-none">${avg}<span class="text-xs font-bold text-gray-400 uppercase ml-0.5">kg</span></div></div><div class="flex flex-col gap-1 items-end min-w-[85px] shrink-0 opacity-60 scale-90 origin-right"><div class="flex gap-1.5"><span class="text-[9px]">ğŸ‘€${f.t1}</span> <span class="text-[9px]">ğŸª${f.t2}</span></div><div class="flex gap-1.5"><span class="text-[9px]">ğŸ§§${f.t3}</span> <span class="text-[9px]">ğŸ¤${f.t4}</span></div><div class="text-[8px] font-black text-gray-300 tracking-tighter">HC:${f.count}</div></div></div><div class="z-10 bg-gray-50 p-1.5 rounded-2xl border border-gray-100"><div class="w-full h-5 flex rounded-full overflow-hidden bg-gray-200 shadow-inner">${f.dist.map((c, i) => c === 0 ? '' : `<div class="${distColors[i]} h-full border-r border-white/20 last:border-0 flex items-center justify-center transition-all duration-1000 overflow-hidden" style="width: ${(c/f.count)*100}%"><span class="text-[7px] font-black text-white px-0.5 truncate">${milestoneShortNames[i]}: ${c} (${Math.round((c/f.count)*100)}%)</span></div>`).join('')}</div></div></div>`;
            }).join('') : `<p class="text-gray-400 text-xs italic text-center py-20">æ²’æœ‰æ•¸æ“šã€‚</p>`;
            lucide.createIcons(); 
        }

        function populateFilterOptions() {
            const bS = document.getElementById('brand-filter'), lS = document.getElementById('location-filter');
            if(!lS || !bS) return;
            const b = bS.value, bPM = { 'Dermes': 'D', 'Reenex': 'R', 'Elyze': 'E' }, p = bPM[b], cV = lS.value;
            let locs = [...new Set(window.USERS.map(u => u.location))].filter(l => l).sort();
            if (p) locs = locs.filter(loc => loc.toUpperCase().startsWith(p));
            lS.innerHTML = `<option value="">æ‰€æœ‰æ¨“å±¤</option>`;
            locs.forEach(loc => { const opt = document.createElement('option'); opt.value = loc; opt.textContent = loc; lS.appendChild(opt); });
            if (locs.includes(cV)) lS.value = cV;
        }

        function populateUserSelect() {
            const bS = document.getElementById('brand-filter'), lS = document.getElementById('location-filter'), uS = document.getElementById('user-select'), uC = document.getElementById('user-card');
            if(!bS || !lS || !uS) return;
            const b = bS.value, l = lS.value, bPM = { 'Dermes': 'D', 'Reenex': 'R', 'Elyze': 'E' }, p = bPM[b];
            uS.innerHTML = '';
            const filtered = window.USERS.filter(u => (!b || (u.brand.toLowerCase().includes(b.toLowerCase()) && u.location.toUpperCase().startsWith(p))) && (!l || u.location === l));
            if (filtered.length === 0) { uS.innerHTML = `<option disabled selected>æ²’æœ‰çµæœ</option>`; if(uC) uC.classList.add('hidden'); return; }
            filtered.forEach(u => { const o = document.createElement('option'); o.value = u.id; o.textContent = `${u.name} (${u.location})`; uS.appendChild(o); });
            updateUserCard(filtered[0].id);
        }

        function updateUserCard(userId) {
            const user = window.USERS.find(u => u.id == userId);
            if (!user) return;
            const uCard = document.getElementById('user-card');
            if(!uCard) return;

            const status = getCowStatus(user.weight);
            const usersInSameTier = window.USERS.filter(u => getCowStatus(u.weight).min === status.min).sort((a, b) => b.weight - a.weight);
            const tierRank = usersInSameTier.findIndex(u => u.id == userId) + 1;
            const rank = window.USERS.findIndex(u => u.id == userId) + 1;
            const next = getNextMilestone(user.weight), lang = window.i18n[window.currentLang];
            
            document.getElementById('card-name').textContent = user.name;
            document.getElementById('card-rank').textContent = `# ${rank}`;
            document.getElementById('card-weight').textContent = `${user.weight}kg`;
            document.getElementById('card-level-title').textContent = status.title[window.currentLang];
            const cBrand = document.getElementById('card-brand'); if(cBrand) { cBrand.textContent = user.brand; cBrand.className = `brand-badge brand-${user.brand.toLowerCase()} text-[9px]`; }
            document.getElementById('card-location').textContent = user.location;
            
            const cardTasksGrid = document.getElementById('card-tasks-grid'); if(cardTasksGrid) cardTasksGrid.innerHTML = [{ label: lang.tLabel1, count: user.task1 }, { label: lang.tLabel2, count: user.task2 }, { label: lang.tLabel3, count: user.task3 }, { label: lang.tLabel4, count: user.task4 }].map(t => `<div class="bg-white p-2 rounded border border-[#D7CCC8] flex justify-between items-center shadow-sm text-left"><span class="text-[#5D4037] font-black">${t.label}</span><span class="font-black text-white bg-[#8D6E63] px-2 py-0.5 rounded-full">${t.count}</span></div>`).join('');
            document.getElementById('card-cow-img').src = status.img;
            
            const rName = document.getElementById('card-reward-name');
            if(rName) {
                let rewardText = status.reward[window.currentLang];
                let hasBonus = false;
                if (status.bonusRank === 3 && status.min === 1100 && tierRank <= 3) hasBonus = true;
                if (status.bonusRank === 3 && status.min === 800 && tierRank <= 3 && user.weight >= 1000) hasBonus = true;
                if (hasBonus) {
                    rewardText = `<span class="text-red-600 font-black">â˜… ${rewardText} + SOGO $${status.bonusValue} ç¾é‡‘åˆ¸</span> <div class="text-[10px] text-gray-400 mt-1">${lang.tierRankLabel} #${tierRank}</div>`;
                    rName.innerHTML = rewardText;
                } else { rName.textContent = rewardText; }
            }

            const nextEl = document.getElementById('card-next-level'), prgEl = document.getElementById('card-progress-bar'), diffEl = document.getElementById('card-diff-text');
            if (next) { if(nextEl) nextEl.textContent = `${lang.goal}: ${next.title[window.currentLang]}`; const prg = Math.min(100, Math.max(0, ((user.weight - status.min) / (next.min - status.min)) * 100)); if(prgEl) prgEl.style.width = `${prg}%`; const feedsLeft = Math.round((next.min - user.weight) / 5); if(diffEl) diffEl.innerHTML = lang.feedsToUpgrade.replace('{n}', `<span class="font-black text-red-600">${feedsLeft}</span>`); } else { if(nextEl) nextEl.textContent = lang.maxLevel; if(prgEl) prgEl.style.width = "100%"; if(diffEl) diffEl.textContent = lang.congrats; }
            
            uCard.classList.remove('hidden');
            lucide.createIcons(); // ç¢ºä¿å¡ç‰‡å…§çš„ icon è¢«æ¸²æŸ“
        }

        async function fetchLeaderboardData() {
            const loading = document.getElementById('loading-indicator');
            try {
                const res = await fetch(window.GOOGLE_SCRIPT_URL);
                const data = await res.json();
                window.USERS = data.map(item => {
                    const nj = getProp(item, ["nj", "NJ"]); // ä¿®æ­£ NJ è­˜åˆ¥
                    const t1 = parseInt(getProp(item, ["task1"]))||0, t2 = parseInt(getProp(item, ["task2"]))||0, t3 = parseInt(getProp(item, ["task3"]))||0, t4 = parseInt(getProp(item, ["task4"]))||0;
                    const stats = calculateStats(t1, t2, t3, t4);
                    return { id: parseInt(getProp(item, ["id"])) || 0, name: getProp(item, ["name"]), brand: getProp(item, ["brand"]), location: getProp(item, ["location"]), task1: t1, task2: t2, task3: t3, task4: t4, feeds: stats.totalFeeds, weight: stats.weight, nj: nj };
                }).filter(u => u.name).sort((a, b) => b.weight - a.weight);
                updateUI(); 
            } catch (error) { console.error("Fetch error:", error); if(loading) loading.innerHTML = `<p class="text-red-500 font-black px-6 text-sm italic text-center">æ•¸æ“šè®€å–å¤±æ•—ã€‚</p>`; } finally { if (loading) loading.classList.add('hidden'); }
        }

        function renderLeaderboard() {
            const grid = document.getElementById('leaderboard-grid');
            if(!grid) return; grid.innerHTML = ''; 
            window.USERS.slice(0, 10).forEach((user, index) => {
                const s = getCowStatus(user.weight), rank = index + 1;
                let rs = rank === 1 ? "bg-yellow-400 text-white w-10 h-10 text-xl border-4 border-white shadow-lg" : rank <= 3 ? "bg-gray-300 text-white w-8 h-8 text-base border-2 border-white shadow-md" : "bg-white text-gray-600 w-6 h-6 text-xs border border-gray-200 shadow-sm";
                const card = document.createElement('div');
                card.className = "relative flex flex-col items-center group";
                card.innerHTML = `<div class="cow-image-container mb-2 transition-all duration-300 relative shadow-2xl"><img src="${s.img}" alt="${s.title[window.currentLang]}" onerror="this.src='https://placehold.co/640x480?text=Loading';"><div class="absolute top-2 left-2 rounded-full flex items-center justify-center font-black rank-badge ${rs}">${rank}</div><div class="absolute bottom-2 right-2 bg-white/95 px-3 py-1 rounded text-sm font-black text-red-600 shadow-md ring-1 ring-red-100">${user.weight}kg</div></div><div class="bg-white/95 backdrop-blur-sm rounded-xl p-3 shadow-xl border-2 ${rank <= 3 ? 'border-yellow-200' : 'border-white'} text-center w-full relative z-30"><div class="text-[13px] font-black text-gray-800 truncate tracking-tighter leading-tight">${user.name}</div><div class="flex justify-center gap-1 mt-1 mb-1"><span class="brand-badge brand-${user.brand.toLowerCase()} scale-90">${user.brand}</span><span class="bg-gray-100 text-gray-500 text-[10px] px-2 rounded-full font-black flex items-center">${user.location}</span></div><div class="text-[10px] font-black tracking-tighter leading-tight ${s.color}">${s.title[window.currentLang]}</div></div>`;
                grid.appendChild(card);
            });
        }

        const bFlt = document.getElementById('brand-filter'), lFlt = document.getElementById('location-filter'), uSlt = document.getElementById('user-select');
        if(bFlt) bFlt.addEventListener('change', () => { populateFilterOptions(); populateUserSelect(); });
        if(lFlt) lFlt.addEventListener('change', populateUserSelect);
        if(uSlt) uSlt.addEventListener('change', (e) => updateUserCard(e.target.value));

        fetchLeaderboardData();
    </script>
</body>
</html>
